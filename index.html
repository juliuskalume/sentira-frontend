<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MoodShelf - AI-Powered Reading Companion</title>

  <!-- Fonts & Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Crimson+Pro:wght@300;400;600&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Markdown parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
      --burgundy: #6b2737;
      --deep-wine: #4a1f29;
      --cream: #f5f1e8;
      --parchment: #e8dcc4;
      --gold: #d4af37;
      --sage: #8b9d83;
      --charcoal: #2d2d34;
    }

    .dark {
      --burgundy: #9d4e5c;
      --deep-wine: #6b2737;
      --cream: #1a1a1f;
      --parchment: #252530;
      --gold: #f4d03f;
      --sage: #a8c5a0;
      --charcoal: #e8dcc4;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Crimson Pro", serif;
      background: var(--cream);
      color: var(--charcoal);
      line-height: 1.6;
      overflow-x: hidden;
    }

    .dark body {
      background: var(--cream);
      color: var(--charcoal);
    }

    h1,
    h2,
    h3,
    h4 {
      font-family: "Playfair Display", serif;
      font-weight: 600;
    }

    .app-container {
      max-width: 600px;
      margin: 0 auto;
      min-height: 100vh;
      background: var(--cream);
      position: relative;
    }

    .bg-pattern {
      position: fixed;
      inset: 0;
      opacity: 0.03;
      background-image: repeating-linear-gradient(
          45deg,
          var(--burgundy) 0px,
          var(--burgundy) 1px,
          transparent 1px,
          transparent 20px
        ),
        repeating-linear-gradient(
          -45deg,
          var(--burgundy) 0px,
          var(--burgundy) 1px,
          transparent 1px,
          transparent 20px
        );
      pointer-events: none;
      z-index: 0;
    }

    .content {
      position: relative;
      z-index: 1;
    }

    .app-header {
      background: linear-gradient(135deg, var(--burgundy), var(--deep-wine));
      color: var(--cream);
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(107, 39, 55, 0.15);
    }

    .logo {
      font-family: "Playfair Display", serif;
      font-size: 1.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-family: "Crimson Pro", serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      display: inline-block;
    }

    .btn-primary {
      background: var(--burgundy);
      color: var(--cream);
      box-shadow: 0 4px 12px rgba(107, 39, 55, 0.2);
    }

    .btn-primary:hover {
      background: var(--deep-wine);
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(107, 39, 55, 0.3);
    }

    .btn-secondary {
      background: var(--parchment);
      color: var(--burgundy);
      border: 2px solid var(--burgundy);
    }

    .btn-secondary:hover {
      background: var(--burgundy);
      color: var(--cream);
    }

    .btn-ghost {
      background: transparent;
      color: var(--burgundy);
      text-decoration: underline;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--burgundy);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--parchment);
      border-radius: 0.5rem;
      font-family: "Crimson Pro", serif;
      font-size: 1rem;
      background: white;
      color: var(--charcoal);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .mood-slider {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: linear-gradient(
        to right,
        #e74c3c,
        #f39c12,
        #f1c40f,
        #2ecc71,
        #27ae60
      );
      outline: none;
    }

    .mood-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--burgundy);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .mood-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--burgundy);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .mood-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .mood-tag {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: 2px solid var(--parchment);
      background: white;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mood-tag.selected {
      background: var(--burgundy);
      color: var(--cream);
      border-color: var(--burgundy);
    }

    .book-card {
      background: white;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .book-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 18px rgba(107, 39, 55, 0.18);
    }

    .book-cover {
      width: 80px;
      height: 120px;
      object-fit: cover;
      border-radius: 0.4rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .loading {
      text-align: center;
      padding: 2.5rem 1rem;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--parchment);
      border-top: 4px solid var(--burgundy);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--parchment);
      border-radius: 3px;
      overflow: hidden;
      margin: 1rem 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--burgundy), var(--gold));
      width: 0%;
      transition: width 0.3s ease;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--cream);
      border-radius: 1rem;
      padding: 1.5rem;
      max-width: 480px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .nav-bar {
      position: sticky;
      bottom: 0;
      background: white;
      border-top: 1px solid var(--parchment);
      display: flex;
      justify-content: space-around;
      padding: 0.6rem 0.5rem;
      box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.08);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.8rem;
      gap: 0.2rem;
      opacity: 0.6;
      cursor: pointer;
      transition: opacity 0.2s ease, color 0.2s ease;
    }

    .nav-item.active,
    .nav-item:hover {
      opacity: 1;
      color: var(--burgundy);
    }

    .disclaimer {
      background: linear-gradient(
        135deg,
        rgba(107, 39, 55, 0.1),
        rgba(74, 31, 41, 0.1)
      );
      border-left: 4px solid var(--burgundy);
      padding: 1rem;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      margin: 1rem 0;
    }

    .summary-content h1,
    .summary-content h2,
    .summary-content h3 {
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
      color: var(--burgundy);
    }

    .summary-content p {
      margin-bottom: 1rem;
    }

    .summary-content ul,
    .summary-content ol {
      margin-left: 1.5rem;
      margin-bottom: 1rem;
    }

    .summary-content blockquote {
      border-left: 4px solid var(--burgundy);
      padding-left: 1rem;
      margin: 1rem 0;
      font-style: italic;
      color: var(--burgundy);
    }
  </style>
</head>
<body>
  <div class="bg-pattern"></div>
  <div class="app-container">
    <div class="content">
      <header class="app-header">
        <div class="logo">
          <span>üìö</span>
          <span>MoodShelf</span>
        </div>
        <p style="font-size: 0.9rem; margin-top: 0.25rem; opacity: 0.9">
          Your mood-based reading companion
        </p>
      </header>

      <main
        id="mainContent"
        style="padding: 1.5rem; min-height: calc(100vh - 200px)"
      ></main>

      <nav class="nav-bar" id="navBar" style="display: none">
        <div class="nav-item" data-view="check-in">
          <span style="font-size: 1.3rem">üåô</span>
          <span>Check-in</span>
        </div>
        <div class="nav-item" data-view="recommendations">
          <span style="font-size: 1.3rem">‚ú®</span>
          <span>Discover</span>
        </div>
        <div class="nav-item" data-view="library">
          <span style="font-size: 1.3rem">üìñ</span>
          <span>My Shelf</span>
        </div>
        <div class="nav-item" data-view="settings">
          <span style="font-size: 1.3rem">‚öôÔ∏è</span>
          <span>Settings</span>
        </div>
      </nav>
    </div>
  </div>

  <!-- MAIN APP SCRIPT -->
  <script type="module">
    // Firebase web v10.12.4 (stable on gstatic)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signInAnonymously,
      onAuthStateChanged,
      signOut,
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const BACKEND_BASE_URL = "https://moodshelf-backend.onrender.com";

    const firebaseConfig = {
      apiKey: "AIzaSyCL-sdYdmc1xNnit9YsKIqtcGNXkcQocVw",
      authDomain: "moodshelfapp.firebaseapp.com",
      projectId: "moodshelfapp",
      storageBucket: "moodshelfapp.firebasestorage.app",
      messagingSenderId: "765678870150",
      appId: "1:765678870150:web:46f7a064029ae984eabb07",
      measurementId: "G-C0RPWHKXKE",
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    auth.languageCode = "en";

    // Dark mode
    if (
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches
    ) {
      document.documentElement.classList.add("dark");
    }
    window
      .matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", (event) => {
        if (event.matches) {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }
      });

    // ------------ APP STATE ------------
    const AppState = {
      user: null,
      profile: null,
      moodHistory: [],
      savedBooks: [],
      currentView: "auth",
      currentMoodCheckIn: null,
      recommendations: [],
      currentBook: null,
      currentSummary: null,

      async initUser(user) {
        this.user = user;

        if (!user) {
          this.profile = null;
          this.moodHistory = [];
          this.savedBooks = [];
          this.currentMoodCheckIn = null;
          this.recommendations = [];
          this.currentBook = null;
          this.currentSummary = null;
          this.currentView = "auth";
          Router.navigate("auth");
          return;
        }

        try {
          const userRef = doc(db, "users", user.uid);
          const snap = await getDoc(userRef);
          if (snap.exists()) {
            const data = snap.data();
            this.profile = data.profile || null;
            this.moodHistory = data.moodHistory || [];
            this.savedBooks = data.savedBooks || [];
          } else {
            await setDoc(userRef, {
              createdAt: new Date().toISOString(),
            });
            this.profile = null;
            this.moodHistory = [];
            this.savedBooks = [];
          }
        } catch (err) {
          console.error("Error loading user data:", err);
          this.profile = null;
          this.moodHistory = [];
          this.savedBooks = [];
        }

        this.currentView = this.profile ? "check-in" : "onboarding";
        Router.navigate(this.currentView);
      },

      async saveProfile(profile) {
        if (!this.user) throw new Error("Not signed in");
        this.profile = profile;
        const userRef = doc(db, "users", this.user.uid);
        await setDoc(
          userRef,
          {
            profile,
            moodHistory: this.moodHistory,
            savedBooks: this.savedBooks,
          },
          { merge: true }
        );
      },

      async saveMood(mood) {
        this.currentMoodCheckIn = mood;
        this.moodHistory.push(mood);
        if (this.user) {
          const userRef = doc(db, "users", this.user.uid);
          await setDoc(userRef, { moodHistory: this.moodHistory }, { merge: true });
        }
      },

      async saveBook(book) {
        if (!this.savedBooks.some((b) => b.id === book.id)) {
          this.savedBooks.push(book);
          if (this.user) {
            const userRef = doc(db, "users", this.user.uid);
            await setDoc(userRef, { savedBooks: this.savedBooks }, { merge: true });
          }
        }
      },

      async removeBook(bookId) {
        this.savedBooks = this.savedBooks.filter((b) => b.id !== bookId);
        if (this.user) {
          const userRef = doc(db, "users", this.user.uid);
          await setDoc(userRef, { savedBooks: this.savedBooks }, { merge: true });
        }
      },

      async clearMoodHistory() {
        this.moodHistory = [];
        this.currentMoodCheckIn = null;
        if (this.user) {
          const userRef = doc(db, "users", this.user.uid);
          await setDoc(userRef, { moodHistory: [] }, { merge: true });
        }
      },

      async resetAll() {
        if (this.user) {
          const userRef = doc(db, "users", this.user.uid);
          await setDoc(
            userRef,
            { profile: null, moodHistory: [], savedBooks: [] },
            { merge: true }
          );
        }
        await signOut(auth);
      },
    };

    // ------------ ROUTER ------------
    const Router = {
      navigate(view) {
        const authedViews = ["check-in", "recommendations", "library", "settings"];
        if (authedViews.includes(view) && !AppState.user) {
          view = "auth";
        }
        if (
          ["check-in", "recommendations", "library", "settings"].includes(view) &&
          !AppState.profile
        ) {
          view = "onboarding";
        }

        AppState.currentView = view;
        this.render(view);
        this.updateNav(view);
      },

      render(view) {
        const main = document.getElementById("mainContent");
        const navBar = document.getElementById("navBar");

        if (view === "auth" || view === "onboarding") {
          navBar.style.display = "none";
        } else {
          navBar.style.display = "flex";
        }

        switch (view) {
          case "auth":
            main.innerHTML = Views.auth();
            Views.initAuth();
            break;
          case "onboarding":
            main.innerHTML = Views.onboarding();
            Views.initOnboarding();
            break;
          case "check-in":
            main.innerHTML = Views.checkIn();
            Views.initCheckIn();
            break;
          case "recommendations":
            main.innerHTML = Views.recommendations();
            Views.initRecommendations();
            break;
          case "library":
            main.innerHTML = Views.library();
            Views.initLibrary();
            break;
          case "settings":
            main.innerHTML = Views.settings();
            Views.initSettings();
            break;
          case "book-detail":
            main.innerHTML = Views.bookDetail();
            Views.initBookDetail();
            break;
          case "summary":
            main.innerHTML = Views.summary();
            Views.initSummary();
            break;
          default:
            main.innerHTML = "<p>View not found</p>";
        }

        window.scrollTo(0, 0);
      },

      updateNav(view) {
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.toggle("active", item.dataset.view === view);
        });
      },
    };

    // ------------ VIEWS ------------
    const Views = {
      // AUTH
      auth() {
        return `
          <div class="max-w-md mx-auto py-8">
            <h2 class="text-2xl font-semibold mb-2 text-[var(--burgundy)]">Welcome to MoodShelf</h2>
            <p class="mb-4 opacity-80">Sign in to save your moods, books, and summaries across devices.</p>

            <div id="authError" class="text-red-600 text-sm mb-3 hidden"></div>

            <button id="btnGoogle" class="btn btn-primary w-full mb-3 flex items-center justify-center gap-2">
              <span>üîê</span><span>Continue with Google</span>
            </button>

            <button id="btnAnonymous" class="btn btn-secondary w-full mb-4">
              Continue as Guest
            </button>

            <div class="border-t border-[var(--parchment)] my-4"></div>

            <h3 class="text-lg font-semibold mb-2 text-[var(--burgundy)]">Email</h3>
            <div class="form-group">
              <label class="form-label" for="emailInput">Email</label>
              <input id="emailInput" type="email" class="form-input" autocomplete="email" />
            </div>
            <div class="form-group">
              <label class="form-label" for="passwordInput">Password</label>
              <input id="passwordInput" type="password" class="form-input" autocomplete="current-password" />
            </div>

            <div class="flex gap-2 mb-4">
              <button id="btnEmailSignIn" class="btn btn-primary flex-1">Sign In</button>
              <button id="btnEmailSignUp" class="btn btn-secondary flex-1">Create Account</button>
            </div>

            <div class="disclaimer">
              <strong>üîí Privacy:</strong> Your account is used only to store your profile, moods, and saved books securely in Firebase.
            </div>
          </div>
        `;
      },

      initAuth() {
        const errorBox = document.getElementById("authError");
        const showError = (msg) => {
          errorBox.textContent = msg;
          errorBox.classList.remove("hidden");
        };

        const clearError = () => {
          errorBox.classList.add("hidden");
          errorBox.textContent = "";
        };

        const btnGoogle = document.getElementById("btnGoogle");
        const btnAnonymous = document.getElementById("btnAnonymous");
        const btnEmailSignIn = document.getElementById("btnEmailSignIn");
        const btnEmailSignUp = document.getElementById("btnEmailSignUp");

        btnGoogle.addEventListener("click", async () => {
          clearError();
          try {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
          } catch (err) {
            console.error(err);
            showError(err.message || "Google sign-in failed.");
          }
        });

        btnAnonymous.addEventListener("click", async () => {
          clearError();
          try {
            await signInAnonymously(auth);
          } catch (err) {
            console.error(err);
            showError(err.message || "Guest sign-in failed.");
          }
        });

        btnEmailSignIn.addEventListener("click", async () => {
          clearError();
          const email = document.getElementById("emailInput").value.trim();
          const password = document.getElementById("passwordInput").value;
          if (!email || !password) {
            showError("Please enter email and password.");
            return;
          }
          try {
            await signInWithEmailAndPassword(auth, email, password);
          } catch (err) {
            console.error(err);
            showError(err.message || "Email sign-in failed.");
          }
        });

        btnEmailSignUp.addEventListener("click", async () => {
          clearError();
          const email = document.getElementById("emailInput").value.trim();
          const password = document.getElementById("passwordInput").value;
          if (!email || !password) {
            showError("Please enter email and password.");
            return;
          }
          try {
            await createUserWithEmailAndPassword(auth, email, password);
          } catch (err) {
            console.error(err);
            showError(err.message || "Account creation failed.");
          }
        });
      },

      // ONBOARDING
      onboarding() {
        const profile = AppState.profile || {};
        return `
          <div class="max-w-md mx-auto py-6">
            <h2 class="text-2xl font-semibold mb-3 text-[var(--burgundy)]">Let's get to know you</h2>
            <p class="mb-4 opacity-80">We use this to tailor your book recommendations and summaries.</p>

            <form id="onboardingForm">
              <div class="onboarding-step" id="obStep1">
                <div class="form-group">
                  <label class="form-label">Your Age *</label>
                  <input id="ageInput" type="number" min="13" max="120" class="form-input" value="${profile.age || ""}" required />
                </div>
                <div class="form-group">
                  <label class="form-label">Gender (optional)</label>
                  <select id="genderInput" class="form-select">
                    <option value="" ${!profile.gender ? "selected" : ""}>Prefer not to say</option>
                    <option value="female" ${profile.gender === "female" ? "selected" : ""}>Female</option>
                    <option value="male" ${profile.gender === "male" ? "selected" : ""}>Male</option>
                    <option value="non-binary" ${profile.gender === "non-binary" ? "selected" : ""}>Non-binary</option>
                    <option value="other" ${profile.gender === "other" ? "selected" : ""}>Other</option>
                  </select>
                </div>
                <button type="button" id="toStep2" class="btn btn-primary w-full">Continue</button>
              </div>

              <div class="onboarding-step hidden" id="obStep2">
                <div class="form-group">
                  <label class="form-label">What genres interest you? *</label>
                  <div id="genreCheckboxes" class="space-y-2">
                    ${[
                      ["self-help", "Self-Help & Personal Development"],
                      ["business", "Business & Career"],
                      ["psychology", "Psychology"],
                      ["fiction", "Fiction"],
                      ["biography", "Biography & Memoir"],
                      ["health", "Health & Wellness"],
                      ["creativity", "Creativity & Arts"],
                      ["philosophy", "Philosophy & Spirituality"],
                    ]
                      .map(
                        ([value, label]) => `
                          <label class="flex items-center gap-2">
                            <input type="checkbox" value="${value}" class="w-5 h-5"
                              ${profile.preferredGenres?.includes(value) ? "checked" : ""} />
                            <span>${label}</span>
                          </label>
                        `
                      )
                      .join("")}
                  </div>
                </div>
                <div class="flex gap-2">
                  <button type="button" id="backTo1" class="btn btn-secondary flex-1">Back</button>
                  <button type="button" id="toStep3" class="btn btn-primary flex-1">Continue</button>
                </div>
              </div>

              <div class="onboarding-step hidden" id="obStep3">
                <div class="form-group">
                  <label class="form-label">What would you like to work on? *</label>
                  <div id="goalsCheckboxes" class="space-y-2">
                    ${[
                      ["focus", "Improve focus and discipline"],
                      ["confidence", "Boost confidence"],
                      ["anxiety", "Reduce anxiety/stress"],
                      ["academic", "Do better in school/studies"],
                      ["social", "Develop social skills"],
                      ["career", "Career and money"],
                      ["creativity", "Creativity and passion"],
                      ["relationships", "Improve relationships"],
                      ["health", "Physical/mental health"],
                    ]
                      .map(
                        ([value, label]) => `
                          <label class="flex items-center gap-2">
                            <input type="checkbox" value="${value}" class="w-5 h-5"
                              ${profile.goals?.includes(value) ? "checked" : ""} />
                            <span>${label}</span>
                          </label>
                        `
                      )
                      .join("")}
                  </div>
                </div>
                <div class="flex gap-2">
                  <button type="button" id="backTo2" class="btn btn-secondary flex-1">Back</button>
                  <button type="button" id="completeSetup" class="btn btn-primary flex-1">Complete setup</button>
                </div>
              </div>
            </form>

            <div id="onboardingError" class="text-red-600 text-sm mt-3 hidden"></div>
          </div>
        `;
      },

      initOnboarding() {
        const step1 = document.getElementById("obStep1");
        const step2 = document.getElementById("obStep2");
        const step3 = document.getElementById("obStep3");
        const errorBox = document.getElementById("onboardingError");

        const showStep = (n) => {
          [step1, step2, step3].forEach((el, idx) => {
            el.classList.toggle("hidden", idx !== n - 1);
          });
        };

        const showError = (msg) => {
          errorBox.textContent = msg;
          errorBox.classList.remove("hidden");
        };
        const clearError = () => {
          errorBox.classList.add("hidden");
          errorBox.textContent = "";
        };

        document.getElementById("toStep2").addEventListener("click", () => {
          clearError();
          const age = parseInt(document.getElementById("ageInput").value, 10);
          if (!age || age < 13 || age > 120) {
            showError("Please enter a valid age (13‚Äì120).");
            return;
          }
          showStep(2);
        });

        document.getElementById("backTo1").addEventListener("click", () => {
          clearError();
          showStep(1);
        });

        document.getElementById("toStep3").addEventListener("click", () => {
          clearError();
          const genres = Array.from(
            document.querySelectorAll("#genreCheckboxes input:checked")
          ).map((cb) => cb.value);
          if (genres.length === 0) {
            showError("Please choose at least one genre.");
            return;
          }
          showStep(3);
        });

        document.getElementById("backTo2").addEventListener("click", () => {
          clearError();
          showStep(2);
        });

        document
          .getElementById("completeSetup")
          .addEventListener("click", async () => {
            clearError();
            const age = parseInt(document.getElementById("ageInput").value, 10);
            const gender = document.getElementById("genderInput").value;
            const genres = Array.from(
              document.querySelectorAll("#genreCheckboxes input:checked")
            ).map((cb) => cb.value);
            const goals = Array.from(
              document.querySelectorAll("#goalsCheckboxes input:checked")
            ).map((cb) => cb.value);

            if (!age || age < 13 || age > 120) {
              showError("Please enter a valid age (13‚Äì120).");
              showStep(1);
              return;
            }
            if (genres.length === 0) {
              showError("Please choose at least one genre.");
              showStep(2);
              return;
            }
            if (goals.length === 0) {
              showError("Please choose at least one goal.");
              return;
            }

            try {
              const profile = {
                age,
                gender,
                preferredGenres: genres,
                goals,
                createdAt: new Date().toISOString(),
              };
              await AppState.saveProfile(profile);
              Router.navigate("check-in");
            } catch (err) {
              console.error(err);
              showError("Error saving profile. Please try again.");
            }
          });

        showStep(1);
      },

      // CHECK-IN
      checkIn() {
        return `
          <div class="max-w-md mx-auto py-6">
            <h2 class="text-2xl font-semibold mb-2 text-[var(--burgundy)]">How are you feeling today?</h2>
            <p class="mb-4 opacity-80">
              Your mood check-in helps us pick books and summaries that match where you are right now.
            </p>

            <div class="form-group">
              <label class="form-label">Mood Level</label>
              <input id="moodSlider" type="range" min="1" max="10" value="5" class="mood-slider" />
              <div class="flex justify-between mt-1 text-xs opacity-70">
                <span>Very low</span>
                <span id="moodLabel">Neutral (5)</span>
                <span>Very high</span>
              </div>
            </div>

            <div class="form-group mt-4">
              <label class="form-label">What are you feeling? (Select all that apply)</label>
              <div id="moodTags" class="mood-tags">
                ${[
                  "üò∞ Anxious|anxious",
                  "üí™ Motivated|motivated",
                  "üòî Lonely|lonely",
                  "üî• Burned Out|burnout",
                  "ü§î Curious|curious",
                  "üåü Hopeful|hopeful",
                  "üò¢ Sad|sad",
                  "üò† Angry|angry",
                  "üòë Bored|bored",
                  "üéâ Excited|excited",
                  "üåä Overwhelmed|overwhelmed",
                  "‚òÆÔ∏è Peaceful|peaceful",
                ]
                  .map((txt) => {
                    const [label, value] = txt.split("|");
                    return `<button type="button"
                              class="mood-tag"
                              data-tag="${value}">${label}</button>`;
                  })
                  .join("")}
              </div>
            </div>

            <div class="form-group mt-4">
              <label class="form-label">What's on your mind? (optional)</label>
              <textarea id="freeText" class="form-textarea" placeholder="Share what you're thinking or worrying about..."></textarea>
            </div>

            <button id="btnCheckInSubmit" class="btn btn-primary w-full mt-2">
              Get book recommendations
            </button>

            <div id="checkInError" class="text-red-600 text-sm mt-3 hidden"></div>
          </div>
        `;
      },

      initCheckIn() {
        const slider = document.getElementById("moodSlider");
        const label = document.getElementById("moodLabel");
        const errorBox = document.getElementById("checkInError");

        const moodLabels = {
          1: "Very low (1)",
          2: "Low (2)",
          3: "Somewhat low (3)",
          4: "Below neutral (4)",
          5: "Neutral (5)",
          6: "Above neutral (6)",
          7: "Somewhat high (7)",
          8: "High (8)",
          9: "Very high (9)",
          10: "Excellent (10)",
        };

        slider.addEventListener("input", (e) => {
          const v = parseInt(e.target.value, 10);
          label.textContent = moodLabels[v] || `Mood (${v})`;
        });

        document.querySelectorAll("#moodTags .mood-tag").forEach((btn) => {
          btn.addEventListener("click", () => {
            btn.classList.toggle("selected");
          });
        });

        document
          .getElementById("btnCheckInSubmit")
          .addEventListener("click", async () => {
            errorBox.classList.add("hidden");
            errorBox.textContent = "";

            const moodScore = parseInt(slider.value, 10);
            const selectedTags = Array.from(
              document.querySelectorAll("#moodTags .mood-tag.selected")
            ).map((el) => el.dataset.tag);

            if (selectedTags.length === 0) {
              errorBox.textContent =
                "Please select at least one mood so we can understand how you feel.";
              errorBox.classList.remove("hidden");
              return;
            }

            const freeText = document.getElementById("freeText").value.trim();

            const mood = {
              moodScore,
              moodTags: selectedTags,
              freeText,
              timestamp: new Date().toISOString(),
            };

            try {
              await AppState.saveMood(mood);
              Router.navigate("recommendations");
            } catch (err) {
              console.error(err);
              errorBox.textContent =
                "Error saving your mood. Please try again.";
              errorBox.classList.remove("hidden");
            }
          });
      },

      // RECOMMENDATIONS
      recommendations() {
        return `
          <div class="max-w-md mx-auto py-6">
            <h2 class="text-2xl font-semibold mb-2 text-[var(--burgundy)]">Books for you</h2>
            <p class="mb-4 opacity-80">
              Based on your profile and today's mood.
            </p>
            <div id="recommendationsContainer">
              <div class="loading">
                <div class="spinner"></div>
                <p>Finding books that match your mood...</p>
              </div>
            </div>
            <button id="btnRefreshRecs" class="btn btn-secondary w-full mt-3">
              üîÑ Get new recommendations
            </button>
          </div>
        `;
      },

      async initRecommendations() {
        if (!AppState.currentMoodCheckIn) {
          Router.navigate("check-in");
          return;
        }
        document
          .getElementById("btnRefreshRecs")
          .addEventListener("click", () => {
            AppState.recommendations = [];
            this.fetchRecommendations();
          });

        if (AppState.recommendations.length > 0) {
          this.displayRecommendations(AppState.recommendations);
        } else {
          await this.fetchRecommendations();
        }
      },

      async fetchRecommendations() {
        const container = document.getElementById("recommendationsContainer");
        container.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <p>Talking to the book genie...</p>
          </div>
        `;
        try {
          const res = await fetch(\`\${BACKEND_BASE_URL}/api/recommendations\`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user: AppState.profile,
              mood: AppState.currentMoodCheckIn,
            }),
          });
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.details || data.error || res.statusText);
          }
          const recommendations = await res.json();
          AppState.recommendations = recommendations || [];
          this.displayRecommendations(recommendations);
        } catch (err) {
          console.error(err);
          container.innerHTML = `
            <div class="text-center py-6">
              <p class="text-red-700 mb-2">Error getting recommendations.</p>
              <p class="text-xs opacity-70 mb-3">${err.message || ""}</p>
              <button id="btnRetryRecs" class="btn btn-primary">Try again</button>
            </div>`;
          document
            .getElementById("btnRetryRecs")
            .addEventListener("click", () => this.fetchRecommendations());
        }
      },

      displayRecommendations(recs) {
        const container = document.getElementById("recommendationsContainer");
        if (!recs || recs.length === 0) {
          container.innerHTML =
            "<p>No recommendations right now. Try refreshing or doing a new mood check-in.</p>";
          return;
        }
        container.innerHTML = recs
          .map(
            (book, idx) => `
              <div class="book-card" data-index="${idx}">
                <div class="flex gap-3">
                  <img src="${book.coverUrl}" class="book-cover"
                    onerror="this.src='https://via.placeholder.com/80x120?text=Book';"/>
                  <div class="flex-1">
                    <h3 class="text-lg font-semibold text-[var(--burgundy)] mb-1">${book.title}</h3>
                    <p class="text-sm opacity-70 mb-1">by ${book.author}</p>
                    <p class="text-sm mb-1">${book.explanation}</p>
                    <div class="flex flex-wrap gap-1 mt-1">
                      <span class="text-xs px-2 py-1 rounded-full bg-[var(--parchment)]">${book.moodAlignment}</span>
                      ${book.tags
                        .slice(0, 2)
                        .map(
                          (t) =>
                            \`<span class="text-xs px-2 py-1 rounded-full bg-[var(--parchment)]">\${t}</span>\`
                        )
                        .join("")}
                    </div>
                  </div>
                </div>
              </div>
            `
          )
          .join("");

        container.querySelectorAll(".book-card").forEach((card) => {
          card.addEventListener("click", () => {
            const idx = parseInt(card.dataset.index, 10);
            AppState.currentBook = AppState.recommendations[idx];
            Router.navigate("book-detail");
          });
        });
      },

      // BOOK DETAIL
      bookDetail() {
        const book = AppState.currentBook;
        if (!book) {
          return `
            <div class="max-w-md mx-auto py-6">
              <p>No book selected.</p>
              <button class="btn btn-primary mt-3" id="backToRecs">Back to recommendations</button>
            </div>`;
        }

        const isSaved = AppState.savedBooks.some((b) => b.id === book.id);
        const moodTags = AppState.currentMoodCheckIn?.moodTags || [];

        return `
          <div class="max-w-md mx-auto py-6">
            <button id="btnBackRecs" class="btn btn-ghost mb-3">‚Üê Back to recommendations</button>
            <div class="text-center mb-4">
              <img src="${book.coverUrl}" class="mx-auto mb-4 rounded shadow-md"
                style="width:180px;height:270px;object-fit:cover;"
                onerror="this.src='https://via.placeholder.com/180x270?text=Book';"/>
              <h2 class="text-2xl font-semibold text-[var(--burgundy)] mb-1">${book.title}</h2>
              <p class="opacity-70 mb-2">by ${book.author}</p>
              <div class="flex flex-wrap justify-center gap-2 mb-2">
                <span class="text-xs px-3 py-1 rounded-full bg-[var(--parchment)]">${book.genre}</span>
                <span class="text-xs px-3 py-1 rounded-full bg-[var(--burgundy)] text-[var(--cream)]">${book.moodAlignment}</span>
              </div>
            </div>

            <div class="bg-white rounded-lg p-4 shadow mb-3">
              <h3 class="font-semibold text-[var(--burgundy)] mb-1">Why this book for you</h3>
              <p class="text-sm">${book.explanation}</p>
            </div>

            <div class="disclaimer mb-3 text-sm">
              <strong>üìö About this book:</strong><br/>
              Chosen for your current mood (${moodTags.join(
                ", "
              )}) and your goals. The summary will give you the core ideas in ~20 minutes.
            </div>

            <div class="flex flex-col gap-2">
              <button id="btnReadSummary" class="btn btn-primary w-full">üìñ Read 20-minute summary</button>
              <button id="btnSaveBook" class="btn btn-secondary w-full">
                ${isSaved ? "‚úì Saved to library" : "üíæ Save to library"}
              </button>
            </div>
          </div>
        `;
      },

      initBookDetail() {
        if (!AppState.currentBook) {
          const btn = document.getElementById("backToRecs");
          if (btn) btn.addEventListener("click", () => Router.navigate("recommendations"));
          return;
        }

        document
          .getElementById("btnBackRecs")
          .addEventListener("click", () => Router.navigate("recommendations"));

        document
          .getElementById("btnReadSummary")
          .addEventListener("click", () => Router.navigate("summary"));

        const btnSave = document.getElementById("btnSaveBook");
        btnSave.addEventListener("click", async () => {
          const book = AppState.currentBook;
          const already = AppState.savedBooks.some((b) => b.id === book.id);
          if (already) {
            await AppState.removeBook(book.id);
          } else {
            await AppState.saveBook(book);
          }
          Router.navigate("book-detail");
          Views.showModal(
            already ? "Removed from library" : "Saved to library",
            already
              ? `"${book.title}" has been removed from your library.`
              : `"${book.title}" has been added to your library.`
          );
        });
      },

      // SUMMARY
      summary() {
        const book = AppState.currentBook;
        if (!book) {
          return `
            <div class="max-w-md mx-auto py-6">
              <p>No book selected.</p>
              <button class="btn btn-primary mt-3" id="backFromSummary">Back to recommendations</button>
            </div>`;
        }
        return `
          <div class="max-w-md mx-auto py-6">
            <button id="btnBackBook" class="btn btn-ghost mb-3">‚Üê Back to book</button>
            <h2 class="text-2xl font-semibold text-[var(--burgundy)] mb-1">${book.title}</h2>
            <p class="opacity-70 mb-2">by ${book.author}</p>

            <div class="progress-bar"><div id="summaryProgress" class="progress-fill"></div></div>
            <p class="text-xs opacity-60 text-center mb-3">Estimated reading time ~20 minutes</p>

            <div id="summaryContent" class="mt-3">
              <div class="loading">
                <div class="spinner"></div>
                <p>Crafting your personalized summary...</p>
              </div>
            </div>

            <div class="flex flex-col gap-2 mt-4">
              <button id="btnListen" class="btn btn-secondary w-full">üéß Listen to audio summary</button>
              <button id="btnMarkComplete" class="btn btn-ghost w-full">‚úì Mark as completed</button>
            </div>
          </div>
        `;
      },

      async initSummary() {
        const book = AppState.currentBook;
        if (!book) {
          const btn = document.getElementById("backFromSummary");
          if (btn) btn.addEventListener("click", () => Router.navigate("recommendations"));
          return;
        }

        document
          .getElementById("btnBackBook")
          .addEventListener("click", () => Router.navigate("book-detail"));

        // TTS state
        let utterance = null;
        let speaking = false;

        const stopSpeech = () => {
          if (window.speechSynthesis) {
            window.speechSynthesis.cancel();
          }
          speaking = false;
          const btn = document.getElementById("btnListen");
          if (btn) btn.textContent = "üéß Listen to audio summary";
        };

        document.getElementById("btnListen").addEventListener("click", () => {
          if (!AppState.currentSummary) {
            Views.showModal(
              "Summary not ready",
              "Please wait for the summary to finish loading first."
            );
            return;
          }
          if (!("speechSynthesis" in window)) {
            Views.showModal(
              "Audio not supported",
              "Your browser doesn't support text-to-speech on this device."
            );
            return;
          }
          const btn = document.getElementById("btnListen");
          if (!speaking) {
            stopSpeech();
            utterance = new SpeechSynthesisUtterance(
              AppState.currentSummary.replace(/[#*_`]/g, "")
            );
            utterance.onend = () => {
              speaking = false;
              if (btn) btn.textContent = "üéß Listen to audio summary";
            };
            speaking = true;
            btn.textContent = "‚è∏ Pause audio";
            window.speechSynthesis.speak(utterance);
          } else {
            stopSpeech();
          }
        });

        document
          .getElementById("btnMarkComplete")
          .addEventListener("click", () => {
            Views.showModal(
              "Nice work üéâ",
              "You‚Äôve completed this summary. Let the ideas simmer."
            );
          });

        // Fetch summary from backend
        const contentEl = document.getElementById("summaryContent");
        const progressEl = document.getElementById("summaryProgress");

        try {
          progressEl.style.width = "10%";
          const res = await fetch(\`\${BACKEND_BASE_URL}/api/summary\`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user: AppState.profile,
              mood: AppState.currentMoodCheckIn,
              book,
            }),
          });
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.details || data.error || res.statusText);
          }
          progressEl.style.width = "40%";
          const data = await res.json();
          const summaryText = data.summary || "";
          AppState.currentSummary = summaryText;
          const html = marked.parse(summaryText);
          contentEl.innerHTML = \`<div class="summary-content">\${html}</div>\`;
          progressEl.style.width = "100%";
        } catch (err) {
          console.error(err);
          contentEl.innerHTML = `
            <div class="text-center py-6">
              <p class="text-red-700 mb-2">Error generating summary.</p>
              <p class="text-xs opacity-70 mb-3">${err.message || ""}</p>
              <button id="btnRetrySummary" class="btn btn-primary">Try again</button>
            </div>
          `;
          progressEl.style.width = "0%";
          document
            .getElementById("btnRetrySummary")
            .addEventListener("click", () => Router.navigate("summary"));
        }
      },

      // LIBRARY
      library() {
        if (!AppState.savedBooks || AppState.savedBooks.length === 0) {
          return `
            <div class="max-w-md mx-auto py-6 text-center">
              <div class="text-4xl mb-2">üìö</div>
              <h2 class="text-xl font-semibold text-[var(--burgundy)] mb-2">Your library is empty</h2>
              <p class="opacity-75 mb-4">Save books you like so you can revisit them later.</p>
              <button id="btnGoDiscover" class="btn btn-primary">Discover books</button>
            </div>
          `;
        }
        const cards = AppState.savedBooks
          .map(
            (book, idx) => `
              <div class="book-card" data-index="${idx}">
                <div class="flex gap-3 items-start">
                  <img src="${book.coverUrl}" class="book-cover"
                    onerror="this.src='https://via.placeholder.com/80x120?text=Book';" />
                  <div class="flex-1">
                    <h3 class="text-lg font-semibold text-[var(--burgundy)] mb-1">${book.title}</h3>
                    <p class="text-sm opacity-70 mb-1">by ${book.author}</p>
                    <p class="text-sm mb-1">${book.explanation}</p>
                  </div>
                  <button class="text-xl" data-remove="${book.id}">üóëÔ∏è</button>
                </div>
              </div>
            `
          )
          .join("");
        return `
          <div class="max-w-md mx-auto py-6">
            <h2 class="text-2xl font-semibold mb-2 text-[var(--burgundy)]">My library</h2>
            <p class="mb-4 opacity-80">Books you've saved to revisit later.</p>
            <div id="libraryList">
              ${cards}
            </div>
          </div>
        `;
      },

      initLibrary() {
        if (!AppState.savedBooks || AppState.savedBooks.length === 0) {
          const btn = document.getElementById("btnGoDiscover");
          if (btn) btn.addEventListener("click", () => Router.navigate("recommendations"));
          return;
        }
        const list = document.getElementById("libraryList");
        list.querySelectorAll(".book-card").forEach((card) => {
          card.addEventListener("click", (e) => {
            const removeId = e.target.dataset.remove;
            if (removeId) {
              e.stopPropagation();
              Views.showConfirmDialog(
                "Remove this book from your library?",
                async () => {
                  await AppState.removeBook(removeId);
                  Router.navigate("library");
                }
              );
              return;
            }
            const idx = parseInt(card.dataset.index, 10);
            AppState.currentBook = AppState.savedBooks[idx];
            Router.navigate("book-detail");
          });
        });
      },

      // SETTINGS
      settings() {
        const p = AppState.profile || {};
        return `
          <div class="max-w-md mx-auto py-6">
            <h2 class="text-2xl font-semibold mb-4 text-[var(--burgundy)]">Settings</h2>

            <div class="bg-white rounded-lg p-4 shadow mb-4">
              <h3 class="font-semibold text-[var(--burgundy)] mb-2">Your profile</h3>
              <p class="text-sm mb-1"><strong>Age:</strong> ${p.age || "Not set"}</p>
              <p class="text-sm mb-1"><strong>Gender:</strong> ${p.gender || "Not specified"}</p>
              <p class="text-sm mb-1"><strong>Preferred genres:</strong> ${
                (p.preferredGenres || []).join(", ") || "Not set"
              }</p>
              <p class="text-sm mb-1"><strong>Goals:</strong> ${
                (p.goals || []).join(", ") || "Not set"
              }</p>
              <button id="btnEditProfile" class="btn btn-ghost mt-2">Edit profile</button>
            </div>

            <div class="bg-white rounded-lg p-4 shadow mb-4">
              <h3 class="font-semibold text-[var(--burgundy)] mb-2">Stats</h3>
              <p class="text-sm mb-1"><strong>Mood check-ins:</strong> ${
                AppState.moodHistory.length
              }</p>
              <p class="text-sm mb-1"><strong>Saved books:</strong> ${
                AppState.savedBooks.length
              }</p>
            </div>

            <div class="disclaimer mb-3 text-sm">
              <strong>üîí Privacy:</strong> We store your data securely in Firebase. You can clear your mood history or reset everything at any time.
            </div>

            <button id="btnClearHistory" class="btn btn-secondary w-full mb-2">
              Clear mood history
            </button>
            <button id="btnResetAll" class="btn btn-ghost w-full mb-2">
              Reset all data & start over
            </button>
            <button id="btnSignOut" class="btn btn-secondary w-full">
              Sign out
            </button>
          </div>
        `;
      },

      initSettings() {
        const btnEditProfile = document.getElementById("btnEditProfile");
        const btnClearHistory = document.getElementById("btnClearHistory");
        const btnResetAll = document.getElementById("btnResetAll");
        const btnSignOut = document.getElementById("btnSignOut");

        btnEditProfile.addEventListener("click", () => {
          Router.navigate("onboarding");
        });

        btnClearHistory.addEventListener("click", () => {
          Views.showConfirmDialog(
            "Clear your entire mood history? You won't be able to undo this.",
            async () => {
              await AppState.clearMoodHistory();
              Router.navigate("settings");
              Views.showModal("Mood history cleared", "Your past check-ins have been removed.");
            }
          );
        });

        btnResetAll.addEventListener("click", () => {
          Views.showConfirmDialog(
            "Reset profile, moods, and saved books and sign out?",
            async () => {
              await AppState.resetAll();
              // onAuthStateChanged will send you back to auth view
            }
          );
        });

        btnSignOut.addEventListener("click", async () => {
          await signOut(auth);
        });
      },

      // UTIL: MODALS
      showModal(title, message) {
        const overlay = document.createElement("div");
        overlay.className = "modal-overlay";
        overlay.innerHTML = `
          <div class="modal-content">
            <h3 class="text-xl font-semibold mb-2 text-[var(--burgundy)]">${title}</h3>
            <p class="mb-4 text-sm">${message}</p>
            <button class="btn btn-primary w-full">OK</button>
          </div>
        `;
        document.body.appendChild(overlay);
        overlay.querySelector("button").addEventListener("click", () => {
          overlay.remove();
        });
      },

      showConfirmDialog(message, onConfirm) {
        const overlay = document.createElement("div");
        overlay.className = "modal-overlay";
        overlay.innerHTML = `
          <div class="modal-content">
            <h3 class="text-xl font-semibold mb-2 text-[var(--burgundy)]">Confirm</h3>
            <p class="mb-4 text-sm">${message}</p>
            <div class="flex gap-2">
              <button class="btn btn-secondary flex-1">Cancel</button>
              <button class="btn btn-primary flex-1">Confirm</button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
        const [cancelBtn, confirmBtn] = overlay.querySelectorAll("button");
        cancelBtn.addEventListener("click", () => overlay.remove());
        confirmBtn.addEventListener("click", async () => {
          try {
            await onConfirm();
          } finally {
            overlay.remove();
          }
        });
      },
    };

    // Make Router / Views visible for debugging if needed
    window.AppState = AppState;
    window.Router = Router;
    window.Views = Views;

    // Nav bar
    function initNav() {
      const nav = document.getElementById("navBar");
      nav.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", () => {
          const view = item.dataset.view;
          Router.navigate(view);
        });
      });
    }

    // Auth listener
    onAuthStateChanged(auth, async (user) => {
      await AppState.initUser(user);
    });

    // Initial load
    window.addEventListener("DOMContentLoaded", () => {
      initNav();
      Router.render("auth");
    });
  </script>
</body>
</html>
