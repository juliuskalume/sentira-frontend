<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>MoodShelf - AI-Powered Reading Companion</title>

  <!-- PWA manifest + theme (kept relative so it works under /<repo>/ as well) -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#6B2737" />

  <!-- Fonts & libs -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Crimson+Pro:wght@300;400;600&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Firebase (compat builds) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --burgundy: #6b2737;
      --deep-wine: #4a1f29;
      --cream: #f5f1e8;
      --parchment: #e8dcc4;
      --gold: #d4af37;
      --sage: #8b9d83;
      --charcoal: #2d2d34;
    }
    .dark {
      --burgundy: #9d4e5c;
      --deep-wine: #6b2737;
      --cream: #1a1a1f;
      --parchment: #252530;
      --gold: #f4d03f;
      --sage: #a8c5a0;
      --charcoal: #e8dcc4;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: "Crimson Pro", serif;
      background: var(--cream);
      color: var(--charcoal);
      line-height: 1.6;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: var(--cream); position: relative; }
    .bg-pattern { position: fixed; inset: 0; opacity: .03;
      background-image:
        repeating-linear-gradient(45deg, var(--burgundy) 0px, var(--burgundy) 1px, transparent 1px, transparent 20px),
        repeating-linear-gradient(-45deg, var(--burgundy) 0px, var(--burgundy) 1px, transparent 1px, transparent 20px);
      pointer-events: none; z-index:0;
    }
    .content { position: relative; z-index: 1; }
    .app-header {
      background: linear-gradient(135deg, var(--burgundy), var(--deep-wine));
      color: var(--cream);
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(107,39,55,.15);
    }
    .logo { font-family:"Playfair Display",serif; font-size:1.75rem; font-weight:700; letter-spacing:.5px; display:flex; align-items:center; gap:.5rem; }
    .btn { padding:.75rem 1.5rem; border:none; border-radius:8px; font-family:"Crimson Pro",serif; font-size:1rem; font-weight:600; cursor:pointer; transition:.2s ease; display:inline-block; }
    .btn-primary { background:var(--burgundy); color:var(--cream); }
    .btn-primary:hover { filter:brightness(1.05); transform:translateY(-1px); }
    .btn-secondary { background:var(--parchment); color:var(--burgundy); border:2px solid var(--burgundy); }
    .btn-secondary:hover { background:var(--burgundy); color:var(--cream); }
    .btn-ghost { background:transparent; color:var(--burgundy); text-decoration:underline; }
    .hidden { display:none !important; }

    .book-card { background:#fff; border-radius:12px; padding:1.25rem; margin-bottom:1.25rem; box-shadow:0 2px 12px rgba(0,0,0,.08); cursor:pointer; }
    .book-cover { width:80px; height:120px; object-fit:cover; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,.15); }

    .nav-bar { position: sticky; bottom: 0; background: white; border-top: 2px solid var(--parchment); display:flex; justify-content:space-around; padding:.75rem; box-shadow:0 -2px 12px rgba(0,0,0,.08); }
    .nav-item { display:flex; flex-direction:column; align-items:center; gap:.25rem; padding:.5rem; opacity:.65; cursor:pointer; }
    .nav-item.active, .nav-item:hover { opacity:1; color:var(--burgundy); }

    .modal-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:1000; }
    .modal-content { background:var(--cream); border-radius:16px; padding:2rem; width:90%; max-width:500px; max-height:80vh; overflow:auto; }

    /* Error overlay so we never look blank */
    #error-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.72); color: #fff; z-index: 99999; display:none; }
    #error-overlay pre { white-space: pre-wrap; word-break: break-word; padding: 1rem; max-height: 60vh; overflow: auto; background: rgba(0,0,0,.35); border: 1px solid rgba(255,255,255,.2); border-radius: 8px; }
  </style>
</head>
<body>
  <div class="bg-pattern"></div>
  <div class="app-container">
    <div class="content">
      <header class="app-header">
        <div class="logo">
          <span>üìö</span><span>MoodShelf</span>
        </div>
        <p style="opacity:.9">Your mood-based reading companion</p>
      </header>

      <main id="mainContent" style="padding:1.5rem; min-height:calc(100vh - 200px)">
        <div style="text-align:center; padding:3rem 1rem;" id="bootSplash">
          <div class="spinner" style="width:48px;height:48px;border:4px solid #e8dcc4;border-top-color:#6b2737;border-radius:50%;margin:0 auto 1rem;animation:spin 1s linear infinite"></div>
          <p>Loading‚Ä¶</p>
        </div>
      </main>

      <nav class="nav-bar hidden" id="navBar">
        <div class="nav-item" data-view="check-in"><span style="font-size:1.5rem">üåô</span><span>Check-in</span></div>
        <div class="nav-item" data-view="recommendations"><span style="font-size:1.5rem">‚ú®</span><span>Discover</span></div>
        <div class="nav-item" data-view="library"><span style="font-size:1.5rem">üìñ</span><span>My Shelf</span></div>
        <div class="nav-item" data-view="settings"><span style="font-size:1.5rem">‚öôÔ∏è</span><span>Settings</span></div>
      </nav>
    </div>
  </div>

  <!-- Error overlay -->
  <div id="error-overlay">
    <div style="max-width:760px;margin:8vh auto;background:#1b1b1b;border-radius:12px;padding:1.25rem;border:1px solid #333">
      <h3 style="margin:0 0 .5rem 0">‚ö†Ô∏è A runtime error occurred</h3>
      <div id="error-msg" style="font-size:.95rem;opacity:.9;margin-bottom:.75rem"></div>
      <pre id="error-stack"></pre>
      <button class="btn btn-secondary" style="margin-top:1rem" onclick="document.getElementById('error-overlay').style.display='none'">Dismiss</button>
    </div>
  </div>

  <script>
    // --------- CRASH SHIELD (show errors on screen instead of silently failing) ----------
    (function() {
      function showOverlay(msg, stack) {
        const el = document.getElementById('error-overlay');
        document.getElementById('error-msg').textContent = String(msg || 'Unknown error');
        document.getElementById('error-stack').textContent = String(stack || '');
        el.style.display = 'block';
      }
      window.addEventListener('error', e => showOverlay(e.message, e.error && e.error.stack));
      window.addEventListener('unhandledrejection', e => showOverlay(e.reason && e.reason.message || e.reason, e.reason && e.reason.stack));
      window.MoodShelfDebugOverlay = { show: showOverlay }; // manual trigger
    })();
  </script>

  <script>
    // ====== CONFIG ======
    const BACKEND_BASE_URL = "https://moodshelf-backend.onrender.com";

    // ====== THEME ======
    try {
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      if (prefersDark) document.documentElement.classList.add("dark");
      window.matchMedia("(prefers-color-scheme: dark)")?.addEventListener("change", e => {
        document.documentElement.classList.toggle("dark", e.matches);
      });
    } catch {}

    // ====== SAFE STORAGE (localStorage fallback) ======
    const Storage = {
      getItem(k){ try { return localStorage.getItem(k); } catch { return null; } },
      setItem(k,v){ try { localStorage.setItem(k,v); } catch {} },
      removeItem(k){ try { localStorage.removeItem(k); } catch {} },
      clear(){ try { localStorage.clear(); } catch {} }
    };

    // ====== Firebase INIT ======
    let auth, db;
    (function initFirebase(){
      try {
        const firebaseConfig = {
          apiKey: "AIzaSyCL-sdYdmc1xNnit9YsKIqtcGNXkcQocVw",
          authDomain: "moodshelfapp.firebaseapp.com",
          projectId: "moodshelfapp",
          storageBucket: "moodshelfapp.firebasestorage.app",
          messagingSenderId: "765678870150",
          appId: "1:765678870150:web:46f7a064029ae984eabb07",
          measurementId: "G-C0RPWHKXKE",
        };
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
      } catch (e) {
        MoodShelfDebugOverlay.show("Firebase failed to initialize. Check Authorized Domains in Firebase Auth settings.", e.stack);
      }
    })();

    // ====== UTIL ======
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const el = (sel)=>document.querySelector(sel);

    // ====== APP STATE ======
    const AppState = {
      user: null,          // profile {age, gender, preferredGenres[], goals[]}
      authUser: null,      // firebase user
      currentView: "welcome",
      currentMoodCheckIn: null,
      recommendations: [],
      savedBooks: [],
      moodHistory: [],
      currentSummary: null,
      audioUrl: null,

      init() {
        try {
          this.user        = JSON.parse(Storage.getItem("moodshelf_user") || "null");
          this.savedBooks  = JSON.parse(Storage.getItem("moodshelf_saved_books") || "[]");
          this.moodHistory = JSON.parse(Storage.getItem("moodshelf_mood_history") || "[]");
        } catch {}
        this.currentView = this.user ? "check-in" : "welcome";
      },

      async saveUser(profile){
        this.user = profile;
        Storage.setItem("moodshelf_user", JSON.stringify(profile));
        try {
          if (this.authUser) await db.collection("users").doc(this.authUser.uid).set(profile, { merge:true });
        } catch(e){ console.warn("Profile sync error:", e); }
      },

      async saveMoodCheckIn(entry){
        this.currentMoodCheckIn = entry;
        this.moodHistory.push({ ...entry, timestamp: new Date().toISOString() });
        Storage.setItem("moodshelf_mood_history", JSON.stringify(this.moodHistory));
        if (!this.authUser) return;
        try {
          const uid = this.authUser.uid;
          await db.collection("users").doc(uid).collection("moodHistory").add({
            ...entry,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          });
        } catch(e){ console.warn("save mood error", e); }
      },

      async saveBook(book){
        if (!this.savedBooks.find(b=>b.id===book.id)) {
          this.savedBooks.push(book);
          Storage.setItem("moodshelf_saved_books", JSON.stringify(this.savedBooks));
        }
        if (!this.authUser) return;
        try {
          const uid = this.authUser.uid;
          await db.collection("users").doc(uid).collection("savedBooks").doc(book.id).set({
            ...book, savedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        } catch(e){ console.warn("save book error", e); }
      },

      async removeBook(bookId){
        this.savedBooks = this.savedBooks.filter(b=>b.id!==bookId);
        Storage.setItem("moodshelf_saved_books", JSON.stringify(this.savedBooks));
        if (!this.authUser) return;
        try {
          const uid = this.authUser.uid;
          await db.collection("users").doc(uid).collection("savedBooks").doc(bookId).delete();
        } catch(e){ console.warn("remove book error", e); }
      },
    };

    // ====== BACKEND SYNC (Fetch remote profile + data) ======
    const Sync = {
      async loadAllFor(user){
        try {
          const uid = user.uid;
          const ref = db.collection("users").doc(uid);

          // Profile
          const snap = await ref.get();
          if (snap.exists) {
            const profile = snap.data() || null;
            if (profile && Object.keys(profile).length) {
              AppState.user = profile;
              Storage.setItem("moodshelf_user", JSON.stringify(profile));
            }
          } else if (AppState.user) {
            await ref.set(AppState.user, { merge:true });
          }

          // Library
          const lib = await ref.collection("savedBooks").get();
          const books = lib.docs.map(d=>d.data());
          if (books.length) {
            AppState.savedBooks = books;
            Storage.setItem("moodshelf_saved_books", JSON.stringify(books));
          }

          // Mood history
          const mh = await ref.collection("moodHistory").orderBy("timestamp","asc").get();
          const moods = mh.docs.map(d=>d.data());
          if (moods.length) {
            AppState.moodHistory = moods;
            Storage.setItem("moodshelf_mood_history", JSON.stringify(moods));
          }

          // If a profile exists and we're on welcome/onboarding, jump to check-in
          if (AppState.user && (Router.view() === "welcome" || Router.view() === "onboarding")) {
            Router.navigate("check-in");
          }
        } catch(e){
          console.warn("loadAllFor error", e);
        }
      }
    };

    // ====== ROUTER ======
    const Router = {
      navigate(view, data = {}) {
        // Protect against showing onboarding once a profile exists
        if (view === "onboarding" && AppState.user) view = "check-in";
        AppState.currentView = view;

        // Nav bar visibility
        const nav = el("#navBar");
        if (["welcome","onboarding"].includes(view)) nav.classList.add("hidden"); else nav.classList.remove("hidden");

        // Active state
        document.querySelectorAll(".nav-item").forEach(i=>{
          i.classList.toggle("active", i.dataset.view===view);
        });

        // Render
        const main = el("#mainContent");
        main.innerHTML = Views[view] ? Views[view](data) : "<p>Unknown view</p>";

        // Init hooks
        if (Views[`init_${view}`]) Views[`init_${view}`](data);
        window.scrollTo(0,0);
      },
      view(){ return AppState.currentView; }
    };

    // ====== VIEWS ======
    const Views = {
      welcome(){
        return `
          <div style="text-align:center; padding:2rem 0;">
            <div style="font-size:5rem; margin-bottom:1rem;">üìö</div>
            <h1 style="font-size:2.25rem; margin-bottom:.5rem;">Welcome to MoodShelf</h1>
            <p style="max-width:420px;margin:0 auto 1.25rem;opacity:.85">
              Discover books that meet you where you are‚Äîemotionally, mentally, and personally.
            </p>
            <div class="disclaimer" style="text-align:left">
              <strong>üìå Notice:</strong> This app offers suggestions only and isn‚Äôt a substitute for professional care.
            </div>
            <div style="display:flex; flex-direction:column; gap:.75rem; margin-top:1rem;">
              <button class="btn btn-primary" onclick="Router.navigate('onboarding')">Get Started</button>
              <button class="btn btn-secondary" onclick="Views.showAuthModal()">I already have an account</button>
            </div>
          </div>
        `;
      },

      onboarding(){
        return `
          <div style="max-width:520px;margin:0 auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
              <h2 style="font-size:1.75rem;color:var(--burgundy)">Let's get to know you</h2>
              <button class="btn-ghost" onclick="Views.showAuthModal()">Sign in</button>
            </div>
            <p style="opacity:.8;margin-bottom:1rem;">If you used MoodShelf before, sign in to restore your profile.</p>

            <form onsubmit="return false;">
              <div id="ob-step1">
                <h3 style="font-size:1.25rem;margin:.5rem 0 1rem">Basic</h3>
                <label class="form-label">Age *</label>
                <input type="number" class="form-input" id="age" min="13" max="120" required />
                <div style="height:.75rem"></div>
                <label class="form-label">Gender (optional)</label>
                <select class="form-select" id="gender">
                  <option value="">Prefer not to say</option>
                  <option value="female">Female</option>
                  <option value="male">Male</option>
                  <option value="non-binary">Non-binary</option>
                  <option value="other">Other</option>
                </select>
                <div style="height:1rem"></div>
                <button class="btn btn-primary" style="width:100%" onclick="Views._obNext(2)">Continue</button>
              </div>

              <div id="ob-step2" class="hidden">
                <h3 style="font-size:1.25rem;margin:.5rem 0 1rem">Genres</h3>
                <div class="checkbox-group" id="genreCheckboxes">
                  ${[
                    ["self-help","Self-Help & Personal Development"],
                    ["business","Business & Career"],
                    ["psychology","Psychology"],
                    ["fiction","Fiction"],
                    ["biography","Biography & Memoir"],
                    ["health","Health & Wellness"],
                    ["creativity","Creativity & Arts"],
                    ["philosophy","Philosophy & Spirituality"],
                  ].map(([v,l])=>`<label class="checkbox-item"><input type="checkbox" value="${v}"/> ${l}</label>`).join("")}
                </div>
                <div style="display:flex;gap:.75rem;margin-top:1rem">
                  <button class="btn btn-secondary" style="flex:1" onclick="Views._obNext(1)">Back</button>
                  <button class="btn btn-primary" style="flex:1" onclick="Views._obNext(3)">Continue</button>
                </div>
              </div>

              <div id="ob-step3" class="hidden">
                <h3 style="font-size:1.25rem;margin:.5rem 0 1rem">Goals</h3>
                <div class="checkbox-group" id="goalsCheckboxes">
                  ${[
                    ["focus","Improve focus and discipline"],
                    ["confidence","Boost confidence"],
                    ["anxiety","Reduce anxiety/stress"],
                    ["academic","Do better in studies"],
                    ["social","Develop social skills"],
                    ["career","Career and money"],
                    ["creativity","Creativity and passion"],
                    ["relationships","Improve relationships"],
                    ["health","Physical/mental health"],
                  ].map(([v,l])=>`<label class="checkbox-item"><input type="checkbox" value="${v}"/> ${l}</label>`).join("")}
                </div>
                <div style="display:flex;gap:.75rem;margin-top:1rem">
                  <button class="btn btn-secondary" style="flex:1" onclick="Views._obNext(2)">Back</button>
                  <button class="btn btn-primary" style="flex:1" onclick="Views._completeOnboarding()">Complete setup</button>
                </div>
              </div>
            </form>
          </div>
        `;
      },
      init_onboarding(){},

      _obNext(step){
        ["#ob-step1","#ob-step2","#ob-step3"].forEach(s=>el(s).classList.add("hidden"));
        el(`#ob-step${step}`).classList.remove("hidden");
      },

      async _completeOnboarding(){
        const age = parseInt(el("#age").value,10);
        const gender = el("#gender").value;
        const genres = Array.from(document.querySelectorAll("#genreCheckboxes input:checked")).map(c=>c.value);
        const goals  = Array.from(document.querySelectorAll("#goalsCheckboxes input:checked")).map(c=>c.value);
        if (!age || !genres.length || !goals.length){
          Views.showModal("Please complete all steps", "Enter your age and select at least one genre and one goal.");
          return;
        }
        await AppState.saveUser({
          age, gender, preferredGenres: genres, goals,
          createdAt: new Date().toISOString(),
        });
        Router.navigate("check-in");
      },

      check_in(){
        return `
          <div style="max-width:520px;margin:0 auto;">
            <h2 style="font-size:1.75rem;margin-bottom:.5rem;color:var(--burgundy)">How are you feeling today?</h2>
            <p style="opacity:.8;margin-bottom:1.25rem">Your mood helps us tailor the books we suggest.</p>

            <label class="form-label">Mood level</label>
            <input type="range" min="1" max="10" value="5" id="moodSlider" class="mood-slider" />
            <div style="display:flex;justify-content:space-between;opacity:.7;font-size:.9rem;margin:.25rem 0 1rem">
              <span>Very low</span><span id="moodValue">Neutral (5)</span><span>Very high</span>
            </div>

            <label class="form-label">What are you feeling? (pick some)</label>
            <div class="mood-tags" id="moodTags">
              ${[
                "üò∞ Anxious|anxious","üí™ Motivated|motivated","üòî Lonely|lonely","üî• Burned Out|burnout",
                "ü§î Curious|curious","üåü Hopeful|hopeful","üò¢ Sad|sad","üò† Angry|angry",
                "üòë Bored|bored","üéâ Excited|excited","üåä Overwhelmed|overwhelmed","‚òÆÔ∏è Peaceful|peaceful",
              ].map(s=>{
                const [label,val]=s.split("|"); return `<div class="mood-tag" data-tag="${val}" style="padding:.5rem 1rem;border:2px solid var(--parchment);border-radius:20px;background:#fff;cursor:pointer">${label}</div>`;
              }).join("")}
            </div>

            <div style="height:1rem"></div>
            <label class="form-label">What's on your mind? (optional)</label>
            <textarea class="form-textarea" id="freeText" placeholder="Share anything relevant‚Ä¶"></textarea>

            <div style="height:1rem"></div>
            <button class="btn btn-primary" style="width:100%" onclick="Views._submitCheckIn()">Get book recommendations</button>
          </div>
        `;
      },
      init_check_in(){
        const slider = el("#moodSlider");
        const label  = el("#moodValue");
        const map = {1:"Very Low (1)",2:"Low (2)",3:"Somewhat Low (3)",4:"Below Neutral (4)",5:"Neutral (5)",6:"Above Neutral (6)",7:"Somewhat High (7)",8:"High (8)",9:"Very High (9)",10:"Excellent (10)"};
        slider.addEventListener("input", e=>label.textContent = map[e.target.value] || e.target.value);
        document.querySelectorAll(".mood-tag").forEach(tag=>{
          tag.addEventListener("click", ()=>tag.classList.toggle("selected"));
        });
      },
      async _submitCheckIn(){
        const score = parseInt(el("#moodSlider").value,10);
        const tags = Array.from(document.querySelectorAll(".mood-tag.selected")).map(t=>t.dataset.tag);
        const free = el("#freeText").value.trim();
        if (!tags.length) { Views.showModal("Select your mood", "Pick at least one mood tag."); return; }
        await AppState.saveMoodCheckIn({ moodScore: score, moodTags: tags, freeText: free, timestamp: new Date().toISOString() });
        Router.navigate("recommendations");
      },

      recommendations(){
        return `
          <div>
            <h2 style="font-size:1.75rem;margin-bottom:.5rem;color:var(--burgundy)">Books for you</h2>
            <p style="opacity:.8;margin-bottom:1rem">Curated for how you feel right now.</p>
            <div id="recommendationsContainer" style="padding:1rem 0">
              <div class="loading" style="text-align:center;padding:2rem 0">
                <div class="spinner" style="width:48px;height:48px;border:4px solid #e8dcc4;border-top-color:#6b2737;border-radius:50%;margin:0 auto 1rem;animation:spin 1s linear infinite"></div>
                <p>Finding books‚Ä¶</p>
              </div>
            </div>
            <button class="btn btn-secondary" style="width:100%" onclick="Views._refreshRecs()">üîÑ Get new recommendations</button>
          </div>
        `;
      },
      async init_recommendations(){ await Views._fetchRecs(); },
      async _refreshRecs(){
        AppState.recommendations = [];
        el("#recommendationsContainer").innerHTML = `<div class="loading" style="text-align:center;padding:2rem 0"><div class="spinner" style="width:48px;height:48px;border:4px solid #e8dcc4;border-top-color:#6b2737;border-radius:50%;margin:0 auto 1rem;animation:spin 1s linear infinite"></div><p>Finding books‚Ä¶</p></div>`;
        await Views._fetchRecs();
      },
      async _fetchRecs(){
        const c = el("#recommendationsContainer");
        const user = AppState.user;
        const mood = AppState.currentMoodCheckIn;
        if (!user || !mood){
          c.innerHTML = `<p style="color:var(--burgundy)">Missing user or mood. Please complete onboarding and check-in.</p>`;
          return;
        }
        try{
          const resp = await fetch(`${BACKEND_BASE_URL}/api/recommendations`, {
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ user, mood })
          });
          const text = await resp.text();
          if (!resp.ok) throw new Error(`${resp.status} ${resp.statusText}\n${text}`);
          let arr; try{ arr = JSON.parse(text); } catch{ throw new Error("Server returned invalid JSON:\n"+text); }
          AppState.recommendations = arr || [];
          if (!arr.length){ c.innerHTML = "<p>No recommendations yet. Try again.</p>"; return; }
          c.innerHTML = arr.map(book=>{
            const safe = JSON.stringify(book).replace(/'/g,"&apos;");
            return `
              <div class="book-card" onclick='Views._openBook(${safe})'>
                <div style="display:flex;gap:1rem">
                  <img class="book-cover" src="${book.coverUrl}" alt="${book.title}" onerror="this.src='https://via.placeholder.com/80x120?text=Book'"/>
                  <div style="flex:1">
                    <h3 style="font-size:1.1rem;color:var(--burgundy)">${book.title}</h3>
                    <p style="opacity:.7;margin-bottom:.25rem">by ${book.author}</p>
                    <p style="font-size:.95rem;margin-bottom:.5rem">${book.explanation}</p>
                    <div style="display:flex;gap:.5rem;flex-wrap:wrap">
                      <span style="background:var(--parchment);padding:.2rem .6rem;border-radius:12px;font-size:.85rem">${book.moodAlignment}</span>
                      ${(book.tags||[]).slice(0,2).map(t=>`<span style="background:var(--parchment);padding:.2rem .6rem;border-radius:12px;font-size:.85rem">${t}</span>`).join("")}
                    </div>
                  </div>
                </div>
              </div>`;
          }).join("");
        }catch(e){
          c.innerHTML = `<div style="padding:1rem;border:1px solid var(--parchment);border-radius:8px"><strong style="color:var(--burgundy)">Error:</strong><pre style="white-space:pre-wrap">${e.message}</pre></div>`;
        }
      },
      _openBook(book){ Router.navigate("book_detail", { book }); },

      book_detail({book}){
        const saved = AppState.savedBooks.some(b=>b.id===book.id);
        const safe = JSON.stringify(book).replace(/'/g,"&apos;");
        return `
          <button class="btn-ghost" onclick="Router.navigate('recommendations')">‚Üê Back</button>
          <div style="text-align:center;margin:1rem 0 1.25rem">
            <img src="${book.coverUrl}" onerror="this.src='https://via.placeholder.com/180x270?text=Book'" alt="${book.title}" style="width:180px;height:270px;object-fit:cover;border-radius:8px;box-shadow:0 4px 18px rgba(0,0,0,.18);margin-bottom:1rem"/>
            <h2 style="font-size:1.6rem;color:var(--burgundy)">${book.title}</h2>
            <p style="opacity:.75;margin-bottom:.5rem">by ${book.author}</p>
            <div style="display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap">
              <span style="background:var(--parchment);padding:.3rem .8rem;border-radius:14px">${book.genre}</span>
              <span style="background:var(--burgundy);color:#fff;padding:.3rem .8rem;border-radius:14px">${book.moodAlignment}</span>
            </div>
          </div>
          <div style="background:#fff;border-radius:12px;padding:1rem;margin-bottom:1rem">
            <h3 style="color:var(--burgundy);margin-bottom:.5rem">Why this book</h3>
            <p>${book.explanation}</p>
          </div>
          <div class="disclaimer"><strong>üìö Note:</strong> Summary is AI-generated for learning.</div>
          <div style="display:flex;flex-direction:column;gap:.75rem">
            <button class="btn btn-primary" onclick='Router.navigate("summary",{book:${safe}})'>üìñ Read Summary</button>
            <button class="btn btn-secondary" onclick='Views._saveBook(${safe})'>${saved?"‚úì Saved to Library":"üíæ Save to Library"}</button>
          </div>
        `;
      },
      async _saveBook(book){
        await AppState.saveBook(book);
        if (!AppState.authUser){
          Views.showConfirm("Saved on this device. Sign in to sync across devices.", ()=>Views.showAuthModal());
        } else {
          Views.showModal("Saved", `"${book.title}" added to your library.`);
        }
        Router.navigate("book_detail", { book });
      },

      summary({book}){
        const safe = JSON.stringify(book).replace(/'/g,"&apos;");
        return `
          <button class="btn-ghost" onclick='Router.navigate("book_detail",{book:${safe}})'>‚Üê Back</button>
          <h2 style="font-size:1.5rem;color:var(--burgundy);margin:.5rem 0">${book.title}</h2>
          <p style="opacity:.75;margin-bottom:.75rem">by ${book.author}</p>
          <div class="progress-bar" style="width:100%;height:6px;background:var(--parchment);border-radius:3px;overflow:hidden;margin:.5rem 0 1rem">
            <div id="summaryProgress" class="progress-fill" style="height:100%;background:linear-gradient(90deg,var(--burgundy),var(--gold));width:0%"></div>
          </div>
          <div id="summaryContent" style="margin-top:1rem">
            <div class="loading" style="text-align:center;padding:2rem 0">
              <div class="spinner" style="width:48px;height:48px;border:4px solid #e8dcc4;border-top-color:#6b2737;border-radius:50%;margin:0 auto 1rem;animation:spin 1s linear infinite"></div>
              <p>Generating summary‚Ä¶</p>
            </div>
          </div>
          <div id="summaryActions" class="hidden" style="display:flex;flex-direction:column;gap:.5rem;margin-top:1rem">
            <button class="btn btn-secondary" onclick="Views._ttsBrowser()">üó£Ô∏è Listen with browser</button>
            <button class="btn btn-secondary" onclick="Views._ttsApi()">üéß Listen with app voice</button>
          </div>
        `;
      },
      async init_summary({book}){
        const content = el("#summaryContent");
        const bar = el("#summaryProgress");
        const user = AppState.user, mood = AppState.currentMoodCheckIn;
        if (!user || !mood){
          content.innerHTML = `<p style="color:var(--burgundy)">Missing user or mood. Go back and check-in again.</p>`;
          return;
        }
        try{
          bar.style.width = "25%";
          const resp = await fetch(`${BACKEND_BASE_URL}/api/summary`, {
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ user, mood, book })
          });
          const txt = await resp.text();
          if (!resp.ok) throw new Error(`${resp.status} ${resp.statusText}\n${txt}`);
          let data; try { data = JSON.parse(txt); } catch { throw new Error("Invalid JSON:\n"+txt); }
          const summary = data.summary || "";
          if (!summary) throw new Error("No summary returned.");
          AppState.currentSummary = summary;
          bar.style.width = "100%";
          content.innerHTML = `<div class="summary-content">${marked.parse(summary)}</div>`;
          el("#summaryActions").classList.remove("hidden");
        }catch(e){
          bar.style.width = "0%";
          content.innerHTML = `<div style="border:1px solid var(--parchment);border-radius:8px;padding:1rem"><strong style="color:var(--burgundy)">Error:</strong><pre style="white-space:pre-wrap">${e.message}</pre></div>`;
        }
      },
      _stripMd(t){ return (t||"").replace(/#{1,6}\s/g,"").replace(/\*\*/g,"").replace(/\*/g,"").replace(/`/g,"").replace(/\[([^\]]+)\]\([^)]+\)/g,"$1").replace(/>\s?/g,"").trim(); },
      _ttsBrowser(){
        if (!AppState.currentSummary) return Views.showModal("No summary", "Generate a summary first.");
        if (!("speechSynthesis" in window)) return Views.showModal("Not supported","Your browser lacks speech synthesis.");
        const synth = speechSynthesis;
        if (synth.speaking){ synth.cancel(); Views.showModal("Stopped","Stopped reading."); return; }
        const u = new SpeechSynthesisUtterance(Views._stripMd(AppState.currentSummary));
        u.rate = 1.0; u.pitch = 1.0; synth.speak(u);
        Views.showModal("Reading started","Tap again to stop.");
      },
      async _ttsApi(){
        if (!AppState.currentSummary) return Views.showModal("No summary","Generate a summary first.");
        const plain = Views._stripMd(AppState.currentSummary);
        const modal = Views._modal(`
          <h3 style="font-size:1.25rem;margin-bottom:.5rem;color:var(--burgundy)">Audio Summary</h3>
          <div id="audioContent"><div class="spinner" style="width:36px;height:36px;border:4px solid #e8dcc4;border-top-color:#6b2737;border-radius:50%;animation:spin 1s linear infinite;margin:1rem auto"></div><p style="text-align:center">Generating audio‚Ä¶</p></div>
          <button class="btn btn-ghost" data-close style="width:100%;margin-top:.75rem">Close</button>
        `);
        try{
          const res = await fetch(`${BACKEND_BASE_URL}/tts`, {
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ text: plain })
          });
          const ct = res.headers.get("content-type")||"";
          if (!res.ok || !ct.toLowerCase().startsWith("audio")){
            const err = await res.text();
            el("#audioContent").innerHTML = `<p style="color:var(--burgundy)"><strong>Audio error:</strong></p><pre style="white-space:pre-wrap">${err}</pre>`;
            return;
          }
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          AppState.audioUrl = url;
          el("#audioContent").innerHTML = `
            <audio controls style="width:100%"><source src="${url}" type="${ct}"/></audio>
            <p style="opacity:.75;margin-top:.5rem">You can pause/resume anytime.</p>`;
        }catch(e){
          el("#audioContent").innerHTML = `<p style="color:var(--burgundy)"><strong>Network error:</strong></p><pre style="white-space:pre-wrap">${e.message}</pre>`;
        }
      },

      library(){
        const arr = AppState.savedBooks;
        if (!arr.length){
          return `
            <div style="text-align:center;padding:2.5rem 1rem">
              <div style="font-size:3rem">üìö</div>
              <h2 style="font-size:1.5rem;margin:.5rem 0;color:var(--burgundy)">Your library is empty</h2>
              <p style="opacity:.8;margin-bottom:1rem">Save books from your recommendations.</p>
              <button class="btn btn-primary" onclick="Router.navigate('recommendations')">Discover books</button>
            </div>`;
        }
        return `
          <h2 style="font-size:1.6rem;margin-bottom:.5rem;color:var(--burgundy)">My Library</h2>
          ${arr.map(book=>{
            const safe = JSON.stringify(book).replace(/'/g,"&apos;");
            return `
              <div class="book-card" onclick='Router.navigate("book_detail",{book:${safe}})'>
                <div style="display:flex;gap:1rem;align-items:flex-start">
                  <img class="book-cover" src="${book.coverUrl}" onerror="this.src='https://via.placeholder.com/80x120?text=Book'"/>
                  <div style="flex:1">
                    <h3 style="font-size:1.05rem;color:var(--burgundy)">${book.title}</h3>
                    <p style="opacity:.7;margin-bottom:.25rem">by ${book.author}</p>
                    <p style="font-size:.95rem">${book.explanation}</p>
                  </div>
                  <button class="btn-ghost" style="font-size:1.25rem" onclick="event.stopPropagation(); Views._removeFromLibrary('${book.id}')">üóëÔ∏è</button>
                </div>
              </div>`;
          }).join("")}
        `;
      },
      async _removeFromLibrary(id){ await AppState.removeBook(id); Router.navigate("library"); },

      settings(){
        const u = AppState.user, a = AppState.authUser;
        return `
          <h2 style="font-size:1.6rem;margin-bottom:1rem;color:var(--burgundy)">Settings</h2>
          <div style="background:#fff;border-radius:12px;padding:1rem;margin-bottom:1rem">
            <h3 style="margin-bottom:.5rem;color:var(--burgundy)">Your Profile</h3>
            ${u ? `
              <div><strong>Age:</strong> ${u.age}</div>
              <div><strong>Gender:</strong> ${u.gender || "Not specified"}</div>
              <div><strong>Preferred Genres:</strong> ${(u.preferredGenres||[]).join(", ")}</div>
              <div><strong>Goals:</strong> ${(u.goals||[]).join(", ")}</div>
            ` : `<p>You haven‚Äôt completed onboarding yet.</p>`}
          </div>

          <div style="background:#fff;border-radius:12px;padding:1rem;margin-bottom:1rem">
            <h3 style="margin-bottom:.5rem;color:var(--burgundy)">Account</h3>
            ${a ? `
              <p><strong>Signed in as:</strong> ${a.email || a.displayName || "Account"}</p>
              <p style="opacity:.8">Your library and mood history sync when you‚Äôre signed in.</p>
              <button class="btn btn-secondary" style="width:100%;margin-top:.5rem" onclick="Views.signOut()">Sign out</button>
            ` : `
              <p style="opacity:.8">Sign in to sync your data across devices.</p>
              <button class="btn btn-primary" style="width:100%;margin-top:.5rem" onclick="Views.showAuthModal()">Sign in / Create account</button>
            `}
          </div>

          <div style="background:#fff;border-radius:12px;padding:1rem;margin-bottom:1rem">
            <h3 style="margin-bottom:.5rem;color:var(--burgundy)">Reading History</h3>
            <div><strong>Mood check-ins:</strong> ${AppState.moodHistory.length}</div>
            <div><strong>Saved books:</strong> ${AppState.savedBooks.length}</div>
          </div>

          <div class="disclaimer" style="margin-bottom:1rem"><strong>üîí Privacy:</strong> We store data locally and in your private account if signed in.</div>
          <div class="disclaimer" style="margin-bottom:1rem"><strong>‚öïÔ∏è Reminder:</strong> Suggestions are not medical advice.</div>

          <button class="btn btn-secondary" style="width:100%;margin-bottom:.5rem" onclick="Views._clearMoods()">Clear mood history</button>
          <button class="btn btn-ghost" style="width:100%" onclick="Views._resetApp()">Reset app on this device</button>
        `;
      },
      async _clearMoods(){
        Views.showConfirm("Clear your mood history? This cannot be undone.", async ()=>{
          AppState.moodHistory = [];
          Storage.removeItem("moodshelf_mood_history");
          if (AppState.authUser){
            try{
              const coll = db.collection("users").doc(AppState.authUser.uid).collection("moodHistory");
              const snap = await coll.get();
              const batch = db.batch();
              snap.forEach(doc=>batch.delete(doc.ref));
              await batch.commit();
            }catch(e){ console.warn("clear moods error", e); }
          }
          Router.navigate("settings");
          Views.showModal("Done", "Mood history cleared.");
        });
      },
      _resetApp(){
        Views.showConfirm("Reset local app data?", ()=>{
          Storage.clear();
          location.reload();
        });
      },

      // ---------- MODALS ----------
      _modal(innerHtml){
        const overlay = document.createElement("div");
        overlay.className = "modal-overlay";
        overlay.innerHTML = `<div class="modal-content">${innerHtml}</div>`;
        overlay.addEventListener("click", (e)=>{ if (e.target.dataset.close !== undefined || e.target === overlay) overlay.remove(); });
        document.body.appendChild(overlay);
        return overlay;
      },
      showModal(title, message){
        const o = Views._modal(`
          <h3 style="font-size:1.25rem;margin-bottom:.5rem;color:var(--burgundy)">${title}</h3>
          <p>${message}</p>
          <button class="btn btn-primary" style="width:100%;margin-top:.75rem" data-close>OK</button>
        `);
        return o;
      },
      showConfirm(message, onYes){
        const o = Views._modal(`
          <h3 style="font-size:1.25rem;margin-bottom:.5rem;color:var(--burgundy)">Confirm</h3>
          <p>${message}</p>
          <div style="display:flex;gap:.75rem;margin-top:.75rem">
            <button class="btn btn-secondary" style="flex:1" data-close>Cancel</button>
            <button class="btn btn-primary" style="flex:1" id="__yes">Confirm</button>
          </div>
        `);
        o.querySelector("#__yes").addEventListener("click", ()=>{ try{ onYes&&onYes(); } finally { o.remove(); } });
        return o;
      },

      // ---------- AUTH ----------
      showAuthModal(){
        Views._modal(`
          <h3 style="font-size:1.25rem;margin-bottom:.5rem;color:var(--burgundy)">Sign in / Create account</h3>
          <p style="opacity:.85;margin-bottom:.75rem">Sync your shelf and moods across devices.</p>
          <button class="btn btn-primary" style="width:100%;margin-bottom:.5rem" onclick="Views._authGoogle()">Continue with Google</button>
          <div style="height:1px;background:var(--parchment);margin:.75rem 0;position:relative">
            <span style="position:absolute;top:-.6rem;left:50%;transform:translateX(-50%);background:var(--cream);padding:0 .5rem;font-size:.8rem;opacity:.7">or use email</span>
          </div>
          <label class="form-label">Email</label>
          <input id="authEmail" type="email" class="form-input" placeholder="you@example.com" />
          <div style="height:.5rem"></div>
          <label class="form-label">Password</label>
          <input id="authPassword" type="password" class="form-input" placeholder="At least 6 characters" />
          <div style="display:flex;gap:.75rem;margin-top:.75rem">
            <button class="btn btn-secondary" style="flex:1" onclick="Views._authEmailSignIn()">Sign in</button>
            <button class="btn btn-secondary" style="flex:1" onclick="Views._authEmailSignUp()">Create account</button>
          </div>
          <button class="btn btn-ghost" style="width:100%;margin-top:.5rem" data-close>Cancel</button>
        `);
      },

      async _authGoogle(){
        try{
          const provider = new firebase.auth.GoogleAuthProvider();
          try {
            await auth.signInWithPopup(provider);
          } catch (e) {
            // fallback for popup blockers / some mobile browsers
            if (String(e && e.code).includes("popup")) {
              await auth.signInWithRedirect(provider);
              return;
            }
            throw e;
          }
          await sleep(120); // allow onAuthStateChanged + Firestore fetch
          if (AppState.user) Router.navigate("check-in");
          Views.showModal("Signed in", "You're now signed in. Sync enabled.");
        }catch(e){
          Views.showModal("Sign-in error", e.message || "Google sign-in failed.");
        }
      },

      async _authEmailSignIn(){
        const email = el("#authEmail").value.trim();
        const pass  = el("#authPassword").value;
        if (!email || !pass) return Views.showModal("Missing info","Enter both email and password.");
        try{
          await auth.signInWithEmailAndPassword(email, pass);
          await sleep(120);
          if (AppState.user) Router.navigate("check-in");
          Views.showModal("Signed in","Sync enabled.");
        }catch(e){
          Views.showModal("Sign-in error", e.message || "Could not sign in.");
        }
      },

      async _authEmailSignUp(){
        const email = el("#authEmail").value.trim();
        const pass  = el("#authPassword").value;
        if (!email || !pass) return Views.showModal("Missing info","Enter both email and password.");
        try{
          await auth.createUserWithEmailAndPassword(email, pass);
          await sleep(120);
          if (AppState.user) Router.navigate("check-in"); else if (Router.view()==="welcome") Router.navigate("onboarding");
          Views.showModal("Account created","You're now signed in.");
        }catch(e){
          Views.showModal("Sign-up error", e.message || "Could not create account.");
        }
      },

      async signOut(){
        try{
          await auth.signOut();
          AppState.authUser = null;
          Views.showModal("Signed out","You‚Äôve been signed out on this device.");
          Router.navigate("settings");
        }catch(e){
          Views.showModal("Sign-out error", e.message || "Could not sign out.");
        }
      }
    };

    // ====== AUTH STATE LISTENER ======
    auth.onAuthStateChanged(async (user)=>{
      AppState.authUser = user || null;
      if (user) await Sync.loadAllFor(user);
    });

    // ====== BOOT ======
    document.addEventListener("DOMContentLoaded", ()=>{
      try{
        document.querySelectorAll(".nav-item").forEach(i=>{
          i.addEventListener("click", ()=>Router.navigate(i.dataset.view.replace("-","_")));
        });
        AppState.init();
        Router.navigate(AppState.currentView.replace("-","_"));
        el("#bootSplash")?.remove();
      }catch(e){
        MoodShelfDebugOverlay.show("Boot error (Router/AppState).", e.stack);
      }
    });

    // ====== SERVICE WORKER (path-safe for GitHub Pages) ======
    if ("serviceWorker" in navigator) {
      const base = (location.pathname.endsWith("/") ? location.pathname : location.pathname.replace(/\/[^\/]*$/, "/"));
      navigator.serviceWorker.register(base + "service-worker.js").catch(err => {
        console.warn("SW registration failed", err);
      });
    }
  </script>
</body>
</html>
