<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MoodShelf - AI-Powered Reading Companion</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Crimson+Pro:wght@300;400;600&display=swap"
    rel="stylesheet"
  />

  <!-- Tailwind (utility classes if you want them) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Markdown parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Firebase (compat SDK for simple use in plain JS/HTML) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --burgundy: #6b2737;
      --deep-wine: #4a1f29;
      --cream: #f5f1e8;
      --parchment: #e8dcc4;
      --gold: #d4af37;
      --sage: #8b9d83;
      --charcoal: #2d2d34;
    }

    .dark {
      --burgundy: #9d4e5c;
      --deep-wine: #6b2737;
      --cream: #1a1a1f;
      --parchment: #252530;
      --gold: #f4d03f;
      --sage: #a8c5a0;
      --charcoal: #e8dcc4;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Crimson Pro", serif;
      background: var(--cream);
      color: var(--charcoal);
      line-height: 1.6;
      overflow-x: hidden;
    }

    .dark body {
      background: var(--cream);
      color: var(--charcoal);
    }

    h1,
    h2,
    h3,
    h4 {
      font-family: "Playfair Display", serif;
      font-weight: 600;
    }

    .app-container {
      max-width: 600px;
      margin: 0 auto;
      min-height: 100vh;
      background: var(--cream);
      position: relative;
    }

    .dark .app-container {
      background: var(--cream);
    }

    /* Animated background pattern */
    .bg-pattern {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: 0.03;
      background-image: repeating-linear-gradient(
          45deg,
          var(--burgundy) 0px,
          var(--burgundy) 1px,
          transparent 1px,
          transparent 20px
        ),
        repeating-linear-gradient(
          -45deg,
          var(--burgundy) 0px,
          var(--burgundy) 1px,
          transparent 1px,
          transparent 20px
        );
      pointer-events: none;
      z-index: 0;
    }

    .content {
      position: relative;
      z-index: 1;
    }

    /* Header */
    .app-header {
      background: linear-gradient(135deg, var(--burgundy), var(--deep-wine));
      color: var(--cream);
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(107, 39, 55, 0.15);
    }

    .logo {
      font-family: "Playfair Display", serif;
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: space-between;
    }

    .header-right {
      font-size: 0.8rem;
      opacity: 0.9;
      text-align: right;
    }

    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-family: "Crimson Pro", serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      display: inline-block;
    }

    .btn-primary {
      background: var(--burgundy);
      color: var(--cream);
      box-shadow: 0 4px 12px rgba(107, 39, 55, 0.2);
    }

    .btn-primary:hover {
      background: var(--deep-wine);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(107, 39, 55, 0.3);
    }

    .btn-secondary {
      background: var(--parchment);
      color: var(--burgundy);
      border: 2px solid var(--burgundy);
    }

    .btn-secondary:hover {
      background: var(--burgundy);
      color: var(--cream);
    }

    .btn-ghost {
      background: transparent;
      color: var(--burgundy);
      text-decoration: underline;
      border: none;
    }

    /* Form elements */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--burgundy);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--parchment);
      border-radius: 8px;
      font-family: "Crimson Pro", serif;
      font-size: 16px;
      background: #ffffff;
      color: var(--charcoal);
      transition: border-color 0.3s ease;
    }

    .dark .form-input,
    .dark .form-select,
    .dark .form-textarea {
      background: var(--parchment);
      border-color: #3a3a45;
      color: var(--charcoal);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--burgundy);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Mood slider */
    .mood-slider {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: linear-gradient(
        to right,
        #e74c3c,
        #f39c12,
        #f1c40f,
        #2ecc71,
        #27ae60
      );
      outline: none;
      opacity: 0.9;
      transition: opacity 0.2s;
    }

    .mood-slider:hover {
      opacity: 1;
    }

    .mood-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--burgundy);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .mood-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--burgundy);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* Mood tags */
    .mood-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .mood-tag {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      border: 2px solid var(--parchment);
      background: #ffffff;
      color: var(--charcoal);
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .dark .mood-tag {
      background: var(--parchment);
      border-color: #3a3a45;
    }

    .mood-tag:hover {
      border-color: var(--burgundy);
    }

    .mood-tag.selected {
      background: var(--burgundy);
      color: var(--cream);
      border-color: var(--burgundy);
    }

    /* Book card */
    .book-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.25rem;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      cursor: pointer;
      animation: fadeInUp 0.5s ease-out;
    }

    .dark .book-card {
      background: var(--parchment);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
    }

    .book-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 24px rgba(107, 39, 55, 0.15);
    }

    .book-cover {
      width: 80px;
      height: 120px;
      object-fit: cover;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 3rem 1rem;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--parchment);
      border-top: 4px solid var(--burgundy);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Progress bar */
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--parchment);
      border-radius: 3px;
      overflow: hidden;
      margin: 1rem 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--burgundy), var(--gold));
      transition: width 0.3s ease;
    }

    /* Audio player (for Web Speech, we just show controls) */
    .audio-player {
      background: #ffffff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      margin: 1rem 0;
    }

    .dark .audio-player {
      background: var(--parchment);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .modal-content {
      background: var(--cream);
      border-radius: 16px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .dark .modal-content {
      background: var(--parchment);
    }

    /* Navigation */
    .nav-bar {
      position: sticky;
      bottom: 0;
      background: #ffffff;
      border-top: 2px solid var(--parchment);
      display: flex;
      justify-content: space-around;
      padding: 0.75rem;
      box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.08);
    }

    .dark .nav-bar {
      background: var(--parchment);
      border-top-color: #3a3a45;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem;
      cursor: pointer;
      color: var(--charcoal);
      opacity: 0.6;
      transition: opacity 0.3s ease;
      font-size: 0.85rem;
    }

    .nav-item:hover,
    .nav-item.active {
      opacity: 1;
      color: var(--burgundy);
    }

    /* Utility */
    .hidden {
      display: none !important;
    }

    .summary-content h1,
    .summary-content h2,
    .summary-content h3 {
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
      color: var(--burgundy);
    }

    .summary-content p {
      margin-bottom: 1rem;
    }

    .summary-content ul,
    .summary-content ol {
      margin-left: 1.5rem;
      margin-bottom: 1rem;
    }

    .summary-content blockquote {
      border-left: 4px solid var(--burgundy);
      padding-left: 1rem;
      margin: 1rem 0;
      font-style: italic;
      color: var(--burgundy);
    }

    .summary-content code {
      background: var(--parchment);
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-family: monospace;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--burgundy);
    }

    .disclaimer {
      background: linear-gradient(
        135deg,
        rgba(107, 39, 55, 0.1),
        rgba(74, 31, 41, 0.1)
      );
      border-left: 4px solid var(--burgundy);
      padding: 1rem;
      border-radius: 8px;
      margin: 1.5rem 0;
      font-size: 0.9rem;
    }

    .dark .disclaimer {
      background: linear-gradient(
        135deg,
        rgba(157, 78, 92, 0.15),
        rgba(107, 39, 55, 0.15)
      );
    }
  </style>
</head>
<body>
  <div class="bg-pattern"></div>
  <div class="app-container">
    <div class="content">
      <!-- Header -->
      <header class="app-header" id="appHeader">
        <div class="logo">
          <div style="display: flex; align-items: center; gap: 0.5rem">
            <span>üìö</span>
            <span>MoodShelf</span>
          </div>
          <div class="header-right" id="authStatus">
            <!-- Filled by JS: "Guest" or "Signed in as ..." -->
          </div>
        </div>
        <p
          style="
            font-size: 0.9rem;
            margin-top: 0.25rem;
            opacity: 0.9;
          "
        >
          Your mood-based reading companion
        </p>
      </header>

      <!-- Main content -->
      <main
        id="mainContent"
        style="padding: 1.5rem; min-height: calc(100vh - 200px)"
      ></main>

      <!-- Navigation bar -->
      <nav class="nav-bar" id="navBar" style="display: none">
        <div class="nav-item" data-view="check-in">
          <span style="font-size: 1.5rem">üåô</span>
          <span>Check-in</span>
        </div>
        <div class="nav-item" data-view="recommendations">
          <span style="font-size: 1.5rem">‚ú®</span>
          <span>Discover</span>
        </div>
        <div class="nav-item" data-view="library">
          <span style="font-size: 1.5rem">üìñ</span>
          <span>My Shelf</span>
        </div>
        <div class="nav-item" data-view="settings">
          <span style="font-size: 1.5rem">‚öôÔ∏è</span>
          <span>Settings</span>
        </div>
      </nav>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const BACKEND_URL = "https://moodshelf-backend.onrender.com";

    // === DARK MODE ===
    if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
      document.documentElement.classList.add("dark");
    }
    window
      .matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", (event) => {
        if (event.matches) {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }
      });

    // === STORAGE (localStorage wrapper) ===
    const Storage = {
      getItem(key) {
        try {
          return window.localStorage.getItem(key);
        } catch (e) {
          return null;
        }
      },
      setItem(key, value) {
        try {
          window.localStorage.setItem(key, value);
        } catch (e) {}
      },
      removeItem(key) {
        try {
          window.localStorage.removeItem(key);
        } catch (e) {}
      },
      clear() {
        try {
          window.localStorage.clear();
        } catch (e) {}
      },
    };

    // === FIREBASE INIT ===
    const firebaseConfig = {
      apiKey: "AIzaSyCL-sdYdmc1xNnit9YsKIqtcGNXkcQocVw",
      authDomain: "moodshelfapp.firebaseapp.com",
      projectId: "moodshelfapp",
      storageBucket: "moodshelfapp.firebasestorage.app",
      messagingSenderId: "765678870150",
      appId: "1:765678870150:web:46f7a064029ae984eabb07",
      measurementId: "G-C0RPWHKXKE",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // === APP STATE ===
    const AppState = {
      authUser: null, // Firebase user
      user: null, // profile: age, gender, genres, goals
      currentView: "welcome",
      currentMoodCheckIn: null,
      recommendations: [],
      savedBooks: [],
      currentBook: null,
      currentSummary: null,
      moodHistory: [],

      init() {
        this.loadFromStorage();
        if (this.user) {
          this.currentView = "check-in";
        }
      },

      loadFromStorage() {
        this.user = JSON.parse(Storage.getItem("moodshelf_user") || "null");
        this.savedBooks = JSON.parse(
          Storage.getItem("moodshelf_saved_books") || "[]"
        );
        this.moodHistory = JSON.parse(
          Storage.getItem("moodshelf_mood_history") || "[]"
        );
      },

      saveUser(userData) {
        this.user = userData;
        Storage.setItem("moodshelf_user", JSON.stringify(userData));
        this.syncToFirestore();
      },

      saveMoodCheckIn(moodData) {
        this.currentMoodCheckIn = moodData;
        this.moodHistory.push({
          ...moodData,
          timestamp: new Date().toISOString(),
        });
        Storage.setItem(
          "moodshelf_mood_history",
          JSON.stringify(this.moodHistory)
        );
        this.syncToFirestore();
      },

      saveBook(book) {
        if (!this.savedBooks.find((b) => b.id === book.id)) {
          this.savedBooks.push(book);
          Storage.setItem(
            "moodshelf_saved_books",
            JSON.stringify(this.savedBooks)
          );
          this.syncToFirestore();
        }
      },

      removeBook(bookId) {
        this.savedBooks = this.savedBooks.filter((b) => b.id !== bookId);
        Storage.setItem(
          "moodshelf_saved_books",
          JSON.stringify(this.savedBooks)
        );
        this.syncToFirestore();
      },

      reset() {
        Storage.clear();
        this.user = null;
        this.savedBooks = [];
        this.moodHistory = [];
        this.currentView = "welcome";
        this.currentBook = null;
        this.currentSummary = null;
        this.syncToFirestore();
      },

      async syncToFirestore() {
        if (!this.authUser) return;
        try {
          await db.collection("users").doc(this.authUser.uid).set(
            {
              profile: this.user,
              savedBooks: this.savedBooks,
              moodHistory: this.moodHistory,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            },
            { merge: true }
          );
        } catch (e) {
          console.warn("Failed to sync to Firestore:", e.message);
        }
      },

      async loadFromFirestoreForUser(uid) {
        try {
          const doc = await db.collection("users").doc(uid).get();
          if (doc.exists) {
            const data = doc.data();
            if (data.profile) {
              // Only override if we don't already have local profile
              if (!this.user) {
                this.user = data.profile;
                Storage.setItem(
                  "moodshelf_user",
                  JSON.stringify(this.user || null)
                );
              }
            }
            if (Array.isArray(data.savedBooks)) {
              this.savedBooks = data.savedBooks;
              Storage.setItem(
                "moodshelf_saved_books",
                JSON.stringify(this.savedBooks)
              );
            }
            if (Array.isArray(data.moodHistory)) {
              this.moodHistory = data.moodHistory;
              Storage.setItem(
                "moodshelf_mood_history",
                JSON.stringify(this.moodHistory)
              );
            }
          }
        } catch (e) {
          console.warn("Failed to load from Firestore:", e.message);
        }
      },
    };

    // === ROUTER ===
    const Router = {
      navigate(view, data = {}) {
        AppState.currentView = view;

        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.remove("active");
          if (item.dataset.view === view) item.classList.add("active");
        });

        this.render(view, data);
      },

      render(view, data) {
        const mainContent = document.getElementById("mainContent");
        const navBar = document.getElementById("navBar");

        if (["welcome", "onboarding"].includes(view)) {
          navBar.style.display = "none";
        } else {
          navBar.style.display = "flex";
        }

        switch (view) {
          case "welcome":
            mainContent.innerHTML = Views.welcome();
            break;
          case "onboarding":
            mainContent.innerHTML = Views.onboarding();
            Views.initOnboarding();
            break;
          case "check-in":
            mainContent.innerHTML = Views.checkIn();
            Views.initCheckIn();
            break;
          case "recommendations":
            mainContent.innerHTML = Views.recommendations();
            Views.initRecommendations();
            break;
          case "book-detail":
            mainContent.innerHTML = Views.bookDetail(data.book);
            Views.initBookDetail(data.book);
            break;
          case "summary":
            mainContent.innerHTML = Views.summary(data.book);
            Views.initSummary(data.book);
            break;
          case "library":
            mainContent.innerHTML = Views.library();
            Views.initLibrary();
            break;
          case "settings":
            mainContent.innerHTML = Views.settings();
            break;
          default:
            mainContent.innerHTML = "<p>View not found</p>";
        }

        window.scrollTo(0, 0);
        Views.updateAuthStatus();
      },
    };

    // === WEB SPEECH (TTS) ===
    let speakingUtterance = null;
    let isSpeaking = false;

    function speakText(text) {
      if (!("speechSynthesis" in window)) {
        Views.showModal(
          "Audio Not Supported",
          "Your browser does not support text-to-speech. Try using a modern browser like Chrome or Edge."
        );
        return;
      }

      if (isSpeaking) {
        window.speechSynthesis.cancel();
        speakingUtterance = null;
        isSpeaking = false;
      }

      const utter = new SpeechSynthesisUtterance(text);
      utter.rate = 1;
      utter.pitch = 1;
      utter.onend = () => {
        isSpeaking = false;
        speakingUtterance = null;
        const btn = document.getElementById("listenBtn");
        if (btn) btn.textContent = "üéß Listen to Audio Summary";
      };
      utter.onerror = () => {
        isSpeaking = false;
        speakingUtterance = null;
        const btn = document.getElementById("listenBtn");
        if (btn) btn.textContent = "üéß Listen to Audio Summary";
      };

      speakingUtterance = utter;
      isSpeaking = true;
      window.speechSynthesis.speak(utter);
    }

    function stopSpeaking() {
      if (!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      speakingUtterance = null;
      isSpeaking = false;
    }

    // === VIEWS ===
    const Views = {
      updateAuthStatus() {
        const el = document.getElementById("authStatus");
        if (!el) return;
        if (AppState.authUser) {
          el.textContent = `Signed in as ${AppState.authUser.email}`;
        } else {
          el.textContent = "Guest";
        }
      },

      welcome() {
        return `
          <div style="text-align: center; padding: 2rem 0;">
            <div style="font-size: 5rem; margin-bottom: 1rem; animation: fadeInUp 0.6s ease-out;">üìö</div>
            <h1 style="font-size: 2.5rem; margin-bottom: 1rem; animation: fadeInUp 0.6s ease-out 0.1s; animation-fill-mode: both;">
              Welcome to MoodShelf
            </h1>
            <p style="font-size: 1.15rem; color: var(--burgundy); margin-bottom: 2rem; max-width: 400px; margin-left: auto; margin-right: auto; animation: fadeInUp 0.6s ease-out 0.2s; animation-fill-mode: both;">
              Discover books that meet you where you are‚Äîemotionally, mentally, and personally.
            </p>

            <div class="disclaimer" style="animation: fadeInUp 0.6s ease-out 0.3s; animation-fill-mode: both;">
              <strong>üìå Important Notice:</strong><br />
              MoodShelf provides reading suggestions based on your mood and goals. This app is <strong>not a substitute for professional mental health care or therapy</strong>. If you're experiencing a crisis or need professional support, please contact a qualified healthcare provider.
            </div>

            <button class="btn btn-primary" onclick="Router.navigate('onboarding')" style="animation: fadeInUp 0.6s ease-out 0.4s; animation-fill-mode: both;">
              Get Started
            </button>
          </div>
        `;
      },

      onboarding() {
        return `
          <div style="max-width: 500px; margin: 0 auto;">
            <h2 style="font-size: 2rem; margin-bottom: 1.5rem; color: var(--burgundy);">Let's Get to Know You</h2>
            <form id="onboardingForm" onsubmit="return false;">
              <div id="step1" class="onboarding-step">
                <h3 style="font-size: 1.5rem; margin-bottom: 1rem;">Basic Information</h3>
                <div class="form-group">
                  <label class="form-label">Your Age *</label>
                  <input type="number" class="form-input" id="age" min="13" max="120" required />
                </div>
                <div class="form-group">
                  <label class="form-label">Gender (Optional)</label>
                  <select class="form-select" id="gender">
                    <option value="">Prefer not to say</option>
                    <option value="female">Female</option>
                    <option value="male">Male</option>
                    <option value="non-binary">Non-binary</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <button type="button" class="btn btn-primary" style="width: 100%;" onclick="Views.nextOnboardingStep(2)">
                  Continue
                </button>
              </div>

              <div id="step2" class="onboarding-step hidden">
                <h3 style="font-size: 1.5rem; margin-bottom: 1rem;">Reading Preferences</h3>
                <div class="form-group">
                  <label class="form-label">What genres interest you? (Select all that apply)</label>
                  <div class="checkbox-group" id="genreCheckboxes">
                    <label class="checkbox-item"><input type="checkbox" value="self-help" /> Self-Help & Personal Development</label>
                    <label class="checkbox-item"><input type="checkbox" value="business" /> Business & Career</label>
                    <label class="checkbox-item"><input type="checkbox" value="psychology" /> Psychology</label>
                    <label class="checkbox-item"><input type="checkbox" value="fiction" /> Fiction</label>
                    <label class="checkbox-item"><input type="checkbox" value="biography" /> Biography & Memoir</label>
                    <label class="checkbox-item"><input type="checkbox" value="health" /> Health & Wellness</label>
                    <label class="checkbox-item"><input type="checkbox" value="creativity" /> Creativity & Arts</label>
                    <label class="checkbox-item"><input type="checkbox" value="philosophy" /> Philosophy & Spirituality</label>
                  </div>
                </div>
                <div style="display: flex; gap: 1rem;">
                  <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="Views.nextOnboardingStep(1)">
                    Back
                  </button>
                  <button type="button" class="btn btn-primary" style="flex: 1;" onclick="Views.nextOnboardingStep(3)">
                    Continue
                  </button>
                </div>
              </div>

              <div id="step3" class="onboarding-step hidden">
                <h3 style="font-size: 1.5rem; margin-bottom: 1rem;">Your Goals</h3>
                <div class="form-group">
                  <label class="form-label">What would you like to work on? (Select all that apply)</label>
                  <div class="checkbox-group" id="goalsCheckboxes">
                    <label class="checkbox-item"><input type="checkbox" value="focus" /> Improve focus and discipline</label>
                    <label class="checkbox-item"><input type="checkbox" value="confidence" /> Boost confidence</label>
                    <label class="checkbox-item"><input type="checkbox" value="anxiety" /> Reduce anxiety/stress</label>
                    <label class="checkbox-item"><input type="checkbox" value="academic" /> Do better in school/studies</label>
                    <label class="checkbox-item"><input type="checkbox" value="social" /> Develop social skills</label>
                    <label class="checkbox-item"><input type="checkbox" value="career" /> Career and money</label>
                    <label class="checkbox-item"><input type="checkbox" value="creativity" /> Creativity and passion</label>
                    <label class="checkbox-item"><input type="checkbox" value="relationships" /> Improve relationships</label>
                    <label class="checkbox-item"><input type="checkbox" value="health" /> Physical/mental health</label>
                  </div>
                </div>
                <div style="display: flex; gap: 1rem;">
                  <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="Views.nextOnboardingStep(2)">
                    Back
                  </button>
                  <button type="button" class="btn btn-primary" style="flex: 1;" onclick="Views.completeOnboarding()">
                    Complete Setup
                  </button>
                </div>
              </div>
            </form>
          </div>
        `;
      },

      initOnboarding() {
        // If we already have profile, prefill:
        if (AppState.user) {
          const { age, gender, preferredGenres, goals } = AppState.user;
          if (age) document.getElementById("age").value = age;
          if (gender) document.getElementById("gender").value = gender;
          if (Array.isArray(preferredGenres)) {
            preferredGenres.forEach((g) => {
              const cb = document.querySelector(
                `#genreCheckboxes input[value="${g}"]`
              );
              if (cb) cb.checked = true;
            });
          }
          if (Array.isArray(goals)) {
            goals.forEach((g) => {
              const cb = document.querySelector(
                `#goalsCheckboxes input[value="${g}"]`
              );
              if (cb) cb.checked = true;
            });
          }
        }
      },

      nextOnboardingStep(step) {
        document
          .querySelectorAll(".onboarding-step")
          .forEach((s) => s.classList.add("hidden"));
        const target = document.getElementById(`step${step}`);
        if (target) target.classList.remove("hidden");
      },

      completeOnboarding() {
        const age = document.getElementById("age").value;
        const gender = document.getElementById("gender").value;
        const genres = Array.from(
          document.querySelectorAll("#genreCheckboxes input:checked")
        ).map((cb) => cb.value);
        const goals = Array.from(
          document.querySelectorAll("#goalsCheckboxes input:checked")
        ).map((cb) => cb.value);

        if (!age || genres.length === 0 || goals.length === 0) {
          Views.showModal(
            "Please Complete All Steps",
            "Please make sure to enter your age and select at least one genre and one goal."
          );
          return;
        }

        const userData = {
          age: parseInt(age, 10),
          gender,
          preferredGenres: genres,
          goals,
          createdAt: new Date().toISOString(),
        };

        AppState.saveUser(userData);
        Router.navigate("check-in");
      },

      checkIn() {
        return `
          <div style="max-width: 500px; margin: 0 auto;">
            <h2 style="font-size: 2rem; margin-bottom: 1rem; color: var(--burgundy);">How are you feeling today?</h2>
            <p style="margin-bottom: 2rem; color: var(--charcoal); opacity: 0.8;">
              Let's check in with your current mood and state of mind. This will help us find books that resonate with you right now.
            </p>

            <div class="form-group">
              <label class="form-label">Mood Level</label>
              <input type="range" class="mood-slider" id="moodSlider" min="1" max="10" value="5" />
              <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.7;">
                <span>Very Low</span>
                <span id="moodValue">Neutral (5)</span>
                <span>Very High</span>
              </div>
            </div>

            <div class="form-group mt-4">
              <label class="form-label">What are you feeling? (Select all that apply)</label>
              <div class="mood-tags" id="moodTags">
                <div class="mood-tag" data-tag="anxious">üò∞ Anxious</div>
                <div class="mood-tag" data-tag="motivated">üí™ Motivated</div>
                <div class="mood-tag" data-tag="lonely">üòî Lonely</div>
                <div class="mood-tag" data-tag="burnout">üî• Burned Out</div>
                <div class="mood-tag" data-tag="curious">ü§î Curious</div>
                <div class="mood-tag" data-tag="hopeful">üåü Hopeful</div>
                <div class="mood-tag" data-tag="sad">üò¢ Sad</div>
                <div class="mood-tag" data-tag="angry">üò† Angry</div>
                <div class="mood-tag" data-tag="bored">üòë Bored</div>
                <div class="mood-tag" data-tag="excited">üéâ Excited</div>
                <div class="mood-tag" data-tag="overwhelmed">üåä Overwhelmed</div>
                <div class="mood-tag" data-tag="peaceful">‚òÆÔ∏è Peaceful</div>
              </div>
            </div>

            <div class="form-group mt-4">
              <label class="form-label">What's on your mind? (Optional)</label>
              <textarea class="form-textarea" id="freeText" placeholder="Share what you're thinking or feeling..."></textarea>
            </div>

            <button class="btn btn-primary" style="width: 100%;" onclick="Views.submitCheckIn()">
              Get Book Recommendations
            </button>
          </div>
        `;
      },

      initCheckIn() {
        const slider = document.getElementById("moodSlider");
        const moodValue = document.getElementById("moodValue");
        const moodLabels = {
          1: "Very Low (1)",
          2: "Low (2)",
          3: "Somewhat Low (3)",
          4: "Below Neutral (4)",
          5: "Neutral (5)",
          6: "Above Neutral (6)",
          7: "Somewhat High (7)",
          8: "High (8)",
          9: "Very High (9)",
          10: "Excellent (10)",
        };
        slider.addEventListener("input", (e) => {
          moodValue.textContent = moodLabels[e.target.value] || `Mood (${e.target.value})`;
        });

        document.querySelectorAll(".mood-tag").forEach((tag) => {
          tag.addEventListener("click", () => {
            tag.classList.toggle("selected");
          });
        });
      },

      async submitCheckIn() {
        const moodScore = parseInt(
          document.getElementById("moodSlider").value,
          10
        );
        const selectedTags = Array.from(
          document.querySelectorAll(".mood-tag.selected")
        ).map((tag) => tag.dataset.tag);
        const freeText = document.getElementById("freeText").value.trim();

        if (selectedTags.length === 0) {
          Views.showModal(
            "Select Your Mood",
            "Please select at least one mood tag to help us understand how you're feeling."
          );
          return;
        }

        const moodData = {
          moodScore,
          moodTags: selectedTags,
          freeText,
          timestamp: new Date().toISOString(),
        };

        AppState.saveMoodCheckIn(moodData);
        Router.navigate("recommendations");
      },

      recommendations() {
        return `
          <div>
            <h2 style="font-size: 2rem; margin-bottom: 1rem; color: var(--burgundy);">Books for You</h2>
            <p style="margin-bottom: 2rem; color: var(--charcoal); opacity: 0.8;">
              Based on your mood and goals, here are some books that might resonate with you right now.
            </p>
            <div id="recommendationsContainer">
              <div class="loading">
                <div class="spinner"></div>
                <p>Finding perfect books for your current mood...</p>
              </div>
            </div>
            <button class="btn btn-secondary" style="width: 100%; margin-top: 1rem;" onclick="Views.refreshRecommendations()">
              üîÑ Get New Recommendations
            </button>
          </div>
        `;
      },

      async initRecommendations() {
        if (!AppState.user || !AppState.currentMoodCheckIn) {
          Views.showModal(
            "Missing Info",
            "Please complete onboarding and a mood check-in first."
          );
          Router.navigate("onboarding");
          return;
        }

        if (AppState.recommendations.length > 0) {
          Views.displayRecommendations(AppState.recommendations);
        } else {
          await Views.fetchRecommendations();
        }
      },

      async fetchRecommendations() {
        const container = document.getElementById("recommendationsContainer");
        container.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <p>Finding perfect books for your current mood...</p>
          </div>
        `;
        try {
          const res = await fetch(`${BACKEND_URL}/api/recommendations`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user: AppState.user,
              mood: AppState.currentMoodCheckIn,
            }),
          });

          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.details || `HTTP ${res.status}`);
          }

          const recommendations = await res.json();
          if (!Array.isArray(recommendations)) {
            throw new Error("Server did not return an array of books.");
          }

          AppState.recommendations = recommendations;
          Views.displayRecommendations(recommendations);
        } catch (err) {
          container.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              <p style="color: var(--burgundy);">Error fetching recommendations: ${
                err.message || err
              }</p>
              <button class="btn btn-primary mt-2" onclick="Views.fetchRecommendations()">Try Again</button>
            </div>
          `;
        }
      },

      displayRecommendations(recs) {
        const container = document.getElementById("recommendationsContainer");
        if (!recs || recs.length === 0) {
          container.innerHTML =
            "<p>No recommendations available. Please try refreshing.</p>";
          return;
        }

        container.innerHTML = recs
          .map(
            (book, index) => `
          <div class="book-card" data-book-index="${index}">
            <div style="display: flex; gap: 1rem;">
              <img src="${book.coverUrl}" alt="${book.title}" class="book-cover"
                   onerror="this.src='https://via.placeholder.com/80x120?text=Book';" />
              <div style="flex: 1;">
                <h3 style="font-size: 1.25rem; margin-bottom: 0.25rem; color: var(--burgundy);">
                  ${book.title}
                </h3>
                <p style="font-size: 0.95rem; opacity: 0.7; margin-bottom: 0.5rem;">by ${
                  book.author
                }</p>
                <p style="font-size: 0.95rem; margin-bottom: 0.5rem;">
                  ${book.explanation}
                </p>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  <span style="background: var(--parchment); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">
                    ${book.moodAlignment}
                  </span>
                  ${(book.tags || [])
                    .slice(0, 2)
                    .map(
                      (tag) => `
                    <span style="background: var(--parchment); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">
                      ${tag}
                    </span>
                  `
                    )
                    .join("")}
                </div>
              </div>
            </div>
          </div>
        `
          )
          .join("");

        document.querySelectorAll(".book-card").forEach((card) => {
          card.addEventListener("click", () => {
            const idx = parseInt(card.dataset.bookIndex, 10);
            const book = AppState.recommendations[idx];
            AppState.currentBook = book;
            Router.navigate("book-detail", { book });
          });
        });
      },

      async refreshRecommendations() {
        AppState.recommendations = [];
        await Views.fetchRecommendations();
      },

      bookDetail(book) {
        const isSaved = AppState.savedBooks.some((b) => b.id === book.id);
        const moodTags =
          (AppState.currentMoodCheckIn &&
            AppState.currentMoodCheckIn.moodTags) ||
          [];
        return `
          <div style="max-width: 500px; margin: 0 auto;">
            <button class="btn btn-ghost mb-2" onclick="Router.navigate('recommendations')">
              ‚Üê Back to Recommendations
            </button>

            <div style="text-align: center; margin-bottom: 2rem;">
              <img src="${book.coverUrl}" alt="${book.title}"
                   style="width: 180px; height: 270px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); margin-bottom: 1.5rem;"
                   onerror="this.src='https://via.placeholder.com/180x270?text=Book';" />
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem; color: var(--burgundy);">
                ${book.title}
              </h2>
              <p style="font-size: 1.15rem; opacity: 0.7; margin-bottom: 1rem;">
                by ${book.author}
              </p>
              <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1.5rem;">
                <span style="background: var(--parchment); padding: 0.4rem 1rem; border-radius: 16px; font-size: 0.9rem;">
                  ${book.genre}
                </span>
                <span style="background: var(--burgundy); color: var(--cream); padding: 0.4rem 1rem; border-radius: 16px; font-size: 0.9rem;">
                  ${book.moodAlignment}
                </span>
              </div>
            </div>

            <div style="background: #ffffff; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
              <h3 style="font-size: 1.25rem; margin-bottom: 0.75rem; color: var(--burgundy);">
                Why This Book for You
              </h3>
              <p>${book.explanation}</p>
            </div>

            <div class="disclaimer mb-3">
              <strong>üìö About This Book:</strong><br />
              This book has been selected based on your current mood (${moodTags.join(
                ", "
              )}) and your goals. The summary you'll read is AI-generated and designed to give you the core ideas in about 20 minutes.
            </div>

            <div style="display: flex; flex-direction: column; gap: 1rem;">
              <button class="btn btn-primary" id="readSummaryBtn">
                üìñ Read 20-Minute Summary
              </button>
              <button class="btn btn-secondary" id="saveBookBtn">
                ${isSaved ? "‚úì Saved to Library" : "üíæ Save to Library"}
              </button>
            </div>
          </div>
        `;
      },

      initBookDetail(book) {
        const readBtn = document.getElementById("readSummaryBtn");
        const saveBtn = document.getElementById("saveBookBtn");
        if (readBtn) {
          readBtn.addEventListener("click", () => {
            Router.navigate("summary", { book });
          });
        }
        if (saveBtn) {
          saveBtn.addEventListener("click", () => {
            Views.saveBookToLibrary(book);
          });
        }
      },

      saveBookToLibrary(book) {
        AppState.saveBook(book);
        Views.showModal(
          "Book Saved!",
          `"${book.title}" has been added to your library.`
        );
        Router.navigate("book-detail", { book });
      },

      summary(book) {
        return `
          <div style="max-width: 600px; margin: 0 auto;">
            <button class="btn btn-ghost mb-2" onclick="Router.navigate('book-detail', {book: AppState.currentBook})">
              ‚Üê Back to Book
            </button>

            <h2 style="font-size: 1.75rem; margin-bottom: 0.5rem; color: var(--burgundy);">
              ${book.title}
            </h2>
            <p style="font-size: 1rem; opacity: 0.7; margin-bottom: 1.5rem;">
              by ${book.author}
            </p>

            <div class="progress-bar">
              <div class="progress-fill" id="summaryProgress" style="width: 10%;"></div>
            </div>
            <p style="font-size: 0.85rem; opacity: 0.6; margin-top: 0.5rem; text-align: center;">
              Estimated reading time: ~20 minutes
            </p>

            <div id="summaryContent" style="margin-top: 2rem;">
              <div class="loading">
                <div class="spinner"></div>
                <p>Generating your personalized summary...</p>
              </div>
            </div>

            <div id="summaryActions" class="hidden" style="margin-top: 2rem; display: flex; gap: 1rem; flex-direction: column;">
              <button class="btn btn-secondary" id="listenBtn">
                üéß Listen to Audio Summary
              </button>
              <button class="btn btn-ghost" onclick="Views.markSummaryComplete()">
                ‚úì Mark as Completed
              </button>
            </div>
          </div>
        `;
      },

      async initSummary(book) {
        const summaryContent = document.getElementById("summaryContent");
        const progressBar = document.getElementById("summaryProgress");
        const actions = document.getElementById("summaryActions");

        progressBar.style.width = "20%";

        try {
          const res = await fetch(`${BACKEND_URL}/api/summary`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user: AppState.user,
              mood: AppState.currentMoodCheckIn,
              book,
            }),
          });

          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.details || `HTTP ${res.status}`);
          }

          const data = await res.json();
          const summary = data.summary || "";
          AppState.currentSummary = summary;

          const html = marked.parse(summary);
          summaryContent.innerHTML = `<div class="summary-content">${html}</div>`;
          progressBar.style.width = "100%";
          actions.classList.remove("hidden");

          const listenBtn = document.getElementById("listenBtn");
          if (listenBtn) {
            listenBtn.addEventListener("click", () => {
              if (isSpeaking) {
                stopSpeaking();
                listenBtn.textContent = "üéß Listen to Audio Summary";
              } else {
                const plainText = summary
                  .replace(/#{1,6}\s/g, "")
                  .replace(/\*\*/g, "")
                  .replace(/\*/g, "")
                  .replace(/`/g, "")
                  .replace(/\[([^\]]+)\]\([^\)]+\)/g, "$1")
                  .trim();
                listenBtn.textContent = "‚èπ Stop Audio";
                speakText(plainText);
              }
            });
          }
        } catch (err) {
          summaryContent.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              <p style="color: var(--burgundy);">Error generating summary: ${
                err.message || err
              }</p>
              <button class="btn btn-primary mt-2" onclick="Router.navigate('summary', {book: AppState.currentBook})">Try Again</button>
            </div>
          `;
          progressBar.style.width = "0%";
        }
      },

      markSummaryComplete() {
        Views.showModal(
          "Summary Completed! üéâ",
          "Great job finishing this summary! The insights you've gained are now part of your reading journey."
        );
      },

      library() {
        const savedBooks = AppState.savedBooks;
        if (!savedBooks || savedBooks.length === 0) {
          return `
            <div style="text-align: center; padding: 3rem 1rem;">
              <div style="font-size: 4rem; margin-bottom: 1rem;">üìö</div>
              <h2 style="font-size: 1.75rem; margin-bottom: 1rem; color: var(--burgundy);">
                Your Library is Empty
              </h2>
              <p style="margin-bottom: 2rem; opacity: 0.8;">
                Save books from your recommendations to build your personal library.
              </p>
              <button class="btn btn-primary" onclick="Router.navigate('recommendations')">
                Discover Books
              </button>
            </div>
          `;
        }

        return `
          <div>
            <h2 style="font-size: 2rem; margin-bottom: 1rem; color: var(--burgundy);">
              My Library
            </h2>
            <p style="margin-bottom: 2rem; opacity: 0.8;">Books you've saved for later</p>
            <div id="libraryList">
              ${savedBooks
                .map(
                  (book, index) => `
                <div class="book-card" data-book-index="${index}">
                  <div style="display: flex; gap: 1rem; align-items: flex-start;">
                    <img src="${book.coverUrl}" alt="${book.title}" class="book-cover"
                         onerror="this.src='https://via.placeholder.com/80x120?text=Book';" />
                    <div style="flex: 1;">
                      <h3 style="font-size: 1.25rem; margin-bottom: 0.25rem; color: var(--burgundy);">
                        ${book.title}
                      </h3>
                      <p style="font-size: 0.95rem; opacity: 0.7; margin-bottom: 0.5rem;">
                        by ${book.author}
                      </p>
                      <p style="font-size: 0.95rem;">
                        ${book.explanation}
                      </p>
                    </div>
                    <button class="btn-ghost" data-remove-id="${book.id}" style="padding: 0.5rem; font-size: 1.25rem;">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              `
                )
                .join("")}
            </div>
          </div>
        `;
      },

      initLibrary() {
        const cards = document.querySelectorAll("#libraryList .book-card");
        cards.forEach((card) => {
          card.addEventListener("click", (e) => {
            // if trash clicked, ignore
            if (e.target && e.target.dataset.removeId) return;
            const idx = parseInt(card.dataset.bookIndex, 10);
            const book = AppState.savedBooks[idx];
            AppState.currentBook = book;
            Router.navigate("book-detail", { book });
          });
        });

        document
          .querySelectorAll("#libraryList [data-remove-id]")
          .forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const id = btn.dataset.removeId;
              Views.removeFromLibrary(id);
            });
          });
      },

      removeFromLibrary(bookId) {
        AppState.removeBook(bookId);
        Router.navigate("library");
      },

      settings() {
        const user = AppState.user;
        const moodHistoryCount = AppState.moodHistory.length;
        const savedCount = AppState.savedBooks.length;
        const authUser = AppState.authUser;

        const profileHtml = user
          ? `
          <div style="background: #ffffff; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <h3 style="font-size: 1.25rem; margin-bottom: 1rem; color: var(--burgundy);">
              Your Profile
            </h3>
            <div style="margin-bottom: 0.75rem;"><strong>Age:</strong> ${
              user.age
            }</div>
            <div style="margin-bottom: 0.75rem;"><strong>Gender:</strong> ${
              user.gender || "Not specified"
            }</div>
            <div style="margin-bottom: 0.75rem;"><strong>Preferred Genres:</strong> ${
              (user.preferredGenres || []).join(", ") || "Not specified"
            }</div>
            <div><strong>Goals:</strong> ${
              (user.goals || []).join(", ") || "Not specified"
            }</div>
          </div>
        `
          : `
          <div style="background: #ffffff; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <h3 style="font-size: 1.25rem; margin-bottom: 1rem; color: var(--burgundy);">
              Your Profile
            </h3>
            <p style="margin-bottom: 1rem;">
              You haven't completed onboarding yet. This helps us personalize book recommendations.
            </p>
            <button class="btn btn-primary" onclick="Router.navigate('onboarding')">
              Complete Onboarding
            </button>
          </div>
        `;

        const accountHtml = authUser
          ? `
          <div style="background: #ffffff; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <h3 style="font-size: 1.25rem; margin-bottom: 1rem; color: var(--burgundy);">
              Account
            </h3>
            <p style="margin-bottom: 0.5rem;"><strong>Signed in as:</strong> ${
              authUser.email
            }</p>
            <button class="btn btn-secondary" style="margin-top: 0.5rem;" onclick="Views.signOut()">
              Sign Out
            </button>
          </div>
        `
          : `
          <div style="background: #ffffff; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <h3 style="font-size: 1.25rem; margin-bottom: 1rem; color: var(--burgundy);">
              Account
            </h3>
            <p style="margin-bottom: 0.75rem;">
              Sign in to sync your library and mood history across devices.
            </p>
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 0.75rem;" onclick="Views.signInWithGoogle()">
              Continue with Google
            </button>
            <div style="margin-top: 0.75rem;">
              <p style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 0.5rem;">
                Or sign in with email:
              </p>
              <input id="emailLogin" class="form-input" placeholder="Email" style="margin-bottom: 0.5rem;" />
              <input id="passwordLogin" type="password" class="form-input" placeholder="Password" style="margin-bottom: 0.5rem;" />
              <button class="btn btn-secondary" style="width: 100%;" onclick="Views.signInWithEmailPassword()">
                Sign in / Register
              </button>
            </div>
          </div>
        `;

        return `
          <div style="max-width: 500px; margin: 0 auto;">
            <h2 style="font-size: 2rem; margin-bottom: 2rem; color: var(--burgundy);">
              Settings
            </h2>
            ${accountHtml}
            ${profileHtml}
            <div style="background: #ffffff; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
              <h3 style="font-size: 1.25rem; margin-bottom: 1rem; color: var(--burgundy);">
                Reading History
              </h3>
              <p style="margin-bottom: 0.5rem;">
                <strong>Mood check-ins:</strong> ${moodHistoryCount}
              </p>
              <p>
                <strong>Saved books:</strong> ${savedCount}
              </p>
            </div>

            <div class="disclaimer mb-3">
              <strong>üîí Privacy & Data:</strong><br />
              If you're signed in, your data is synced securely to your MoodShelf account. Otherwise, it's stored only on this device.
            </div>

            <div class="disclaimer mb-3">
              <strong>‚öïÔ∏è Important Reminder:</strong><br />
              MoodShelf provides reading suggestions, not medical or psychological diagnosis. If you're experiencing serious distress, please contact a qualified mental health professional.
            </div>

            <button class="btn btn-secondary" style="width: 100%; margin-bottom: 1rem;" onclick="Views.clearMoodHistory()">
              Clear Mood History
            </button>

            <button class="btn btn-ghost" style="width: 100%; color: var(--burgundy);" onclick="Views.resetApp()">
              Reset All Data & Start Over
            </button>
          </div>
        `;
      },

      clearMoodHistory() {
        Views.showConfirmDialog(
          "Are you sure you want to clear your mood history? This action cannot be undone.",
          () => {
            AppState.moodHistory = [];
            Storage.removeItem("moodshelf_mood_history");
            AppState.syncToFirestore();
            Router.navigate("settings");
            Views.showModal("History Cleared", "Your mood history has been cleared.");
          }
        );
      },

      resetApp() {
        Views.showConfirmDialog(
          "Are you sure you want to reset all data? This will delete your profile, saved books, and mood history. This action cannot be undone.",
          () => {
            AppState.reset();
            Router.navigate("welcome");
          }
        );
      },

      showModal(title, message) {
        const modal = document.createElement("div");
        modal.className = "modal-overlay";
        modal.innerHTML = `
          <div class="modal-content">
            <h3 style="font-size: 1.5rem; margin-bottom: 1rem; color: var(--burgundy);">
              ${title}
            </h3>
            <p style="margin-bottom: 1.5rem;">${message}</p>
            <button class="btn btn-primary" style="width: 100%;" onclick="this.closest('.modal-overlay').remove()">
              OK
            </button>
          </div>
        `;
        document.body.appendChild(modal);
      },

      showConfirmDialog(message, onConfirm) {
        const modal = document.createElement("div");
        modal.className = "modal-overlay";
        modal.innerHTML = `
          <div class="modal-content">
            <h3 style="font-size: 1.5rem; margin-bottom: 1rem; color: var(--burgundy);">
              Confirm Action
            </h3>
            <p style="margin-bottom: 1.5rem;">${message}</p>
            <div style="display: flex; gap: 1rem;">
              <button class="btn btn-secondary" style="flex: 1;" onclick="this.closest('.modal-overlay').remove()">
                Cancel
              </button>
              <button class="btn btn-primary" style="flex: 1;" onclick="this.closest('.modal-overlay').remove(); (${onConfirm})()">
                Confirm
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      },

      // === AUTH HELPERS ===
      async signInWithGoogle() {
        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          const result = await auth.signInWithPopup(provider);
          AppState.authUser = result.user;
          await AppState.loadFromFirestoreForUser(result.user.uid);
          Views.updateAuthStatus();
          AppState.syncToFirestore();
          Router.navigate(AppState.currentView);
        } catch (e) {
          Views.showModal("Sign-in Error", e.message || String(e));
        }
      },

      async signInWithEmailPassword() {
        const emailEl = document.getElementById("emailLogin");
        const passEl = document.getElementById("passwordLogin");
        const email = emailEl ? emailEl.value.trim() : "";
        const password = passEl ? passEl.value : "";

        if (!email || !password) {
          Views.showModal(
            "Missing Info",
            "Please enter both email and password."
          );
          return;
        }

        try {
          let userCredential;
          try {
            userCredential = await auth.signInWithEmailAndPassword(
              email,
              password
            );
          } catch (err) {
            if (err.code === "auth/user-not-found") {
              userCredential = await auth.createUserWithEmailAndPassword(
                email,
                password
              );
            } else {
              throw err;
            }
          }

          AppState.authUser = userCredential.user;
          await AppState.loadFromFirestoreForUser(userCredential.user.uid);
          Views.updateAuthStatus();
          AppState.syncToFirestore();
          Router.navigate(AppState.currentView);
        } catch (err) {
          Views.showModal("Sign-in Error", err.message || String(err));
        }
      },

      async signOut() {
        try {
          await auth.signOut();
          AppState.authUser = null;
          Views.updateAuthStatus();
          Router.navigate("settings");
        } catch (e) {
          Views.showModal("Sign-out Error", e.message || String(e));
        }
      },
    };

    // === INIT ===
    document.addEventListener("DOMContentLoaded", () => {
      // Nav bar handlers
      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", () => {
          Router.navigate(item.dataset.view);
        });
      });

      // Firebase auth listener
      auth.onAuthStateChanged(async (user) => {
        AppState.authUser = user || null;
        if (user) {
          await AppState.loadFromFirestoreForUser(user.uid);
        }
        Views.updateAuthStatus();
        // Re-render current view to reflect auth state
        Router.render(AppState.currentView, {
          book: AppState.currentBook,
        });
      });

      AppState.init();
      Router.navigate(AppState.currentView);
    });
  </script>
</body>
</html>
